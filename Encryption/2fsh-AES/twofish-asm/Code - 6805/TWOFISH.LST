  Tue Jun 16 20:06:03 1998                                                                                               Page    1

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998




               2500 A.D. 6805 Macro Assembler  -  Version 5.02a
               ------------------------------------------------

                       Input  Filename : twofish.asm
                       Output Filename : twofish.obj
                       Listing Has Been Relocated                               


    1                         		.TITLE	 	Twofish for 6805
    2                         		.SUBTITLE	Author: Doug Whiting, Hi/fn, May 1998
    3                         	;
    4                         	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    5                         	;	Copyright 1998, Hi/fn.  All rights reserved	
    6                         	;
    7                         	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    8                         	;
    9                         		.symbols
   10                         		.linklist
   11                         		.debug asm
   12                         		.spaces	on
   13                         	;
   14                         	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   15                         	;	Speed/space tradeoff settings
   16                         	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   17                         	; Set all to 1 to minimize time, 0 to minimize code size
   18                         	;
   19         0001            	UNROLL_SUBKEY	.equ	1	;use two f32s in computeSubkey
   20         0000            	USE_ALPHA_TAB	.equ	0	;use 256-byte alpha lookup table
   21         0001            	USE_MDS_TAB	.equ	1	;use two 256-byte lookups  (EF, 5B)
   22         0001            	UNROLL_ROUND	.equ	1	;use unique round code
   23                         	
   24                         	;
   25                         	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   26                         	;	Constant definitions
   27                         	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   28                         	;
   29         0010            	BLK_SIZE	equ	16
   30         0010            	KEY_SIZE	equ	16
   31         0010            	ROUNDS		equ	16
   32         00B4            	GF_FDBK		equ	(169h.SHR.1)
   33                         	
   34                         	;
   35                         	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   36                         		.PAGE0		;RAM variables
   37                         	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   38                         	;
   39         0050            	RAM0	.var	$
   40  0050                   	Text	.blkb	BLK_SIZE	;encryption block goes here
   41  0060                   	K32e	.blkb	KEY_SIZE/4	;encryption key   goes here
   42  0064                   	K32o	.blkb	KEY_SIZE/4	;(even dword,odd dword,RS dword)
   43  0068                   	SboxKey	.blkb	KEY_SIZE/4
   44         000C            	KBUMP	.var	$-K32e
   45  006C                   		.blkb	KBUMP		;(even dword,odd dword,RS dword)
   46  0078                   	sk0	.blkb	4		;round subkey
  Tue Jun 16 20:06:03 1998                                                                                               Page    2

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

   47  007C                   	sk1	.blkb	4		
   48  0080                   	t0	.blkb	4		;t0 MUST follow sk1 directly!
   49  0084                   	t1	.blkb	4
   50  0088                   	sPtr	.blkb	1
   51  0089                   	round	.blkb	1		;round number
   52  008A                   	tmp	.blkb	2
   53                         	
   54         003C            	RAM_size .var	$-RAM0
   55                         	
   56                         	; variables for the test code
   57  008C                   	kTabPtr	.blkb	1
   58  008D                   	tmpPtr	.blkb	1
   59                         	;
   60                         	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   61                         		.CODE
   62                         	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   63                         	;
   64                         		; test data structure
   65  0100                   	keyTable:
   66  0100                   		include	vector.inc	;load vectors generated by C code
   67                         	; Twofish vector #1
   68                         	    ;Key Size:
   69  0100   80              		.byte	080h
   70                         	    ;Key:
   71  0101   00 00 00 00 00  		.byte	000h,000h,000h,000h,000h,000h,000h,000h
               00 00 00 
   72  0109   00 00 00 00 00  		.byte	000h,000h,000h,000h,000h,000h,000h,000h
               00 00 00 
   73                         	    ;Plaintext:
   74  0111   00 00 00 00 00  		.byte	000h,000h,000h,000h,000h,000h,000h,000h
               00 00 00 
   75  0119   00 00 00 00 00  		.byte	000h,000h,000h,000h,000h,000h,000h,000h
               00 00 00 
   76                         	    ;Ciphertext:
   77  0121   9F 58 9F 5C F6  		.byte	09Fh,058h,09Fh,05Ch,0F6h,012h,02Ch,032h
               12 2C 32 
   78  0129   B6 BF EC 2F 2A  		.byte	0B6h,0BFh,0ECh,02Fh,02Ah,0E8h,0C3h,05Ah
               E8 C3 5A 
   79                         	;-------------------------------------------------------
   80                         	; Twofish vector #2
   81                         	    ;Key Size:
   82  0131   80              		.byte	080h
   83                         	    ;Key:
   84  0132   9F 58 9F 5C F6  		.byte	09Fh,058h,09Fh,05Ch,0F6h,012h,02Ch,032h
               12 2C 32 
   85  013A   B6 BF EC 2F 2A  		.byte	0B6h,0BFh,0ECh,02Fh,02Ah,0E8h,0C3h,05Ah
               E8 C3 5A 
   86                         	    ;Plaintext:
   87  0142   9F 58 9F 5C F6  		.byte	09Fh,058h,09Fh,05Ch,0F6h,012h,02Ch,032h
               12 2C 32 
   88  014A   B6 BF EC 2F 2A  		.byte	0B6h,0BFh,0ECh,02Fh,02Ah,0E8h,0C3h,05Ah
               E8 C3 5A 
   89                         	    ;Ciphertext:
   90  0152   1B 1B 18 6D FE  		.byte	01Bh,01Bh,018h,06Dh,0FEh,04Fh,01Fh,0C4h
               4F 1F C4 
   91  015A   38 5B C7 6F F3  		.byte	038h,05Bh,0C7h,06Fh,0F3h,0CAh,040h,027h
               CA 40 27 
  Tue Jun 16 20:06:03 1998                                                                                               Page    3

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

   92                         	;-------------------------------------------------------
   93                         	; Twofish vector #3
   94                         	    ;Key Size:
   95  0162   80              		.byte	080h
   96                         	    ;Key:
   97  0163   84 43 87 31 08  		.byte	084h,043h,087h,031h,008h,05Dh,033h,0F6h
               5D 33 F6 
   98  016B   8E E4 2B 40 D9  		.byte	08Eh,0E4h,02Bh,040h,0D9h,022h,083h,07Dh
               22 83 7D 
   99                         	    ;Plaintext:
  100  0173   1B 1B 18 6D FE  		.byte	01Bh,01Bh,018h,06Dh,0FEh,04Fh,01Fh,0C4h
               4F 1F C4 
  101  017B   38 5B C7 6F F3  		.byte	038h,05Bh,0C7h,06Fh,0F3h,0CAh,040h,027h
               CA 40 27 
  102                         	    ;Ciphertext:
  103  0183   80 1D AA 23 37  		.byte	080h,01Dh,0AAh,023h,037h,0D8h,0DBh,039h
               D8 DB 39 
  104  018B   5B EC C2 A7 55  		.byte	05Bh,0ECh,0C2h,0A7h,055h,0C5h,0D0h,085h
               C5 D0 85 
  105                         	;-------------------------------------------------------
  106                         	; Twofish vector #4
  107                         	    ;Key Size:
  108  0193   80              		.byte	080h
  109                         	    ;Key:
  110  0194   9B 06 B2 4E C9  		.byte	09Bh,006h,0B2h,04Eh,0C9h,097h,0C4h,0FDh
               97 C4 FD 
  111  019C   63 B7 05 C8 A6  		.byte	063h,0B7h,005h,0C8h,0A6h,00Fh,090h,0A2h
               0F 90 A2 
  112                         	    ;Plaintext:
  113  01A4   80 1D AA 23 37  		.byte	080h,01Dh,0AAh,023h,037h,0D8h,0DBh,039h
               D8 DB 39 
  114  01AC   5B EC C2 A7 55  		.byte	05Bh,0ECh,0C2h,0A7h,055h,0C5h,0D0h,085h
               C5 D0 85 
  115                         	    ;Ciphertext:
  116  01B4   5B 0A 52 93 01  		.byte	05Bh,00Ah,052h,093h,001h,060h,055h,0D6h
               60 55 D6 
  117  01BC   14 4C E8 38 A9  		.byte	014h,04Ch,0E8h,038h,0A9h,0EFh,05Ah,0EBh
               EF 5A EB 
  118                         	;-------------------------------------------------------
  119                         	
  120  01C4   00              		.byte 0	;end of list
  121                         	
  122                         	
  123                         	;
  124                         	;----------------------------------------------------------------
  125                         	; MDS matrix:
  126                         	;
  127                         	;      01  EF  5B  5B		; 5B = alpha**-2 + 1
  128                         	;      5B  EF  EF  01		; EF = alpha**-2 + alpha**-1 + 1
  129                         	;      EF  5B  01  EF
  130                         	;      EF  01  EF  5B
  131                         	;----------------------------------------------------------------
  132                         	;
  133                         	; Load src byte, run through S-box.  Return result in X
  134                         	;
  135         01C5            	codeSize	.var $
  136         0000            	Sbox8ByteCnt	.var 0
  Tue Jun 16 20:06:03 1998                                                                                               Page    4

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  137         0000            	Sbox8CallCnt	.var 0
  138         0000            	f32ByteCnt	.var 0
  139         0000            	f32Size		.var 0
  140         0000            	swap1ByteCnt	.var 0
  141         0000            	op1ByteCnt	.var 0
  142         0000            	rotByteCnt	.var 0
  143                         	
  144         [01]            	  .ife USE_ALPHA_TAB.and.(.not.USE_MDS_TAB)
  145                         	mulAlpha .macro			;do the alpha thing inline
  146                         		lsra
  147                         		bcc	$+4
  148                         		eor	#GF_FDBK
  149                         	    .endm
  150         [00]            	  .endif
  151                         	
  152                         	; key < 4 --> use X as ptr to key
  153                         	Sbox8	.macro	src,q0,q1,q2,key
  154                         	tmpS8		.var $
  155                         	  .if key.lt.4			;use X as key ptr?
  156                         	      .if key.eq.0
  157                         		stx	sPtr
  158                         	      .else
  159                         		ldx	sPtr
  160                         	      .endif
  161                         		lda	key+KBUMP,X
  162                         		ldx	src
  163                         		eor	q0,X
  164                         		tax
  165                         		lda	q1,X
  166                         		ldx	sPtr
  167                         		eor	key,X
  168                         	  .else
  169                         		ldx	src
  170                         		lda	q0,X
  171                         		eor	key+KBUMP
  172                         		tax
  173                         		lda	q1,X
  174                         		eor	key
  175                         	  .endif
  176                         		tax
  177                         	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
  178                         		ldx	q2,X		;return result in X
  179                         	  .else
  180                         		lda	q2,X		;return result in A
  181                         	  .endif
  182                         	Sbox8CallCnt	.var Sbox8CallCnt+1
  183                         	Sbox8Size	.var $-tmpS8
  184                         	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
  185                         		.endm	
  186                         	
  187                         	; key == 0 --> use X as ptr to key
  188                         	f32	.macro	srcB0,rotCnt,step,dst,key
  189                         	tmpf32		.var $
  190                         		;--- 1st byte, first MDS column = 01 5B EF EF
  191                         		Sbox8	srcB0+((rotCnt+step*0).AND.3),p0,p0,p1,key
  192                         	  .if USE_MDS_TAB
  193                         		stx	tmp
  Tue Jun 16 20:06:03 1998                                                                                               Page    5

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  194                         	  .else
  195                         	    .if USE_ALPHA_TAB
  196                         		stx	dst		;X = 01
  197                         		ldx	alpha,X
  198                         		stx	tmp+1
  199                         		lda	alpha,X
  200                         	    .else 
  201                         		sta	dst		;A = 01.  Store it
  202                         		mulAlpha		;a=a*alpha**-1
  203                         		sta	tmp+1
  204                         		mulAlpha
  205                         	    .endif
  206                         		eor	dst		;now A = 5B
  207                         		sta	dst+1
  208                         		eor	tmp+1		;now A = EF
  209                         		sta	dst+2
  210                         		sta	dst+3
  211                         	  .endif
  212                         		;--- 2nd byte, 2nd MDS column = EF EF 5B 01
  213                         		Sbox8	srcB0+((rotCnt+step*1).AND.3),p1,p0,p0,key+1
  214                         	  .if USE_MDS_TAB
  215                         		stx	tmp+1
  216                         	  .else
  217                         	    .if USE_ALPHA_TAB
  218                         		stx	tmp
  219                         		txa
  220                         		eor	dst+3
  221                         		sta	dst+3
  222                         		ldx	alpha,X
  223                         		stx	tmp+1		;tmp+1 = alpha**-1
  224                         		lda	alpha,X
  225                         	    .else
  226                         		sta	tmp		;save the 01 thing
  227                         		eor	dst+3
  228                         		sta	dst+3		;xor the 01
  229                         		lda	tmp
  230                         		mulAlpha
  231                         		sta	tmp+1
  232                         		mulAlpha
  233                         	    .endif
  234                         		eor	tmp		;now A = 5B
  235                         		tax			;save 5B in X
  236                         		eor	dst+2
  237                         		sta	dst+2
  238                         		txa			;A = 5B
  239                         		eor	tmp+1		;now A = EF
  240                         		tax			;save 5F in X
  241                         		eor	dst+1
  242                         		sta	dst+1
  243                         		txa	
  244                         		eor	dst
  245                         		sta	dst
  246                         	  .endif
  247                         		;--- 3rd byte, 3rd MDS column = 5B EF 01 EF
  248                         		Sbox8	srcB0+((rotCnt+step*2).AND.3),p0,p1,p1,key+2
  249                         	  .if USE_MDS_TAB
  250                         		stx	dst+3		;very careful ordering
  Tue Jun 16 20:06:03 1998                                                                                               Page    6

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  251                         	  .else
  252                         	    .if USE_ALPHA_TAB
  253                         		stx	dst+2
  254                         		txa
  255                         		eor	dst+2
  256                         		sta	dst+2
  257                         		ldx	alpha,X
  258                         		stx	tmp+1		;tmp+1 = alpha**-1
  259                         		lda	alpha,X
  260                         	    .else
  261                         		sta	tmp		;save the 01 thing
  262                         		eor	dst+2
  263                         		sta	dst+2		;xor the 01
  264                         		lda	tmp
  265                         		mulAlpha
  266                         		sta	tmp+1
  267                         		mulAlpha
  268                         	    .endif
  269                         		eor	tmp		;now A = 5B
  270                         		tax			;save 5B in X
  271                         		eor	dst
  272                         		sta	dst
  273                         		txa			;A = 5B
  274                         		eor	tmp+1		;now A = EF
  275                         		tax			;save 5F in X
  276                         		eor	dst+1
  277                         		sta	dst+1
  278                         		txa	
  279                         		eor	dst+3
  280                         		sta	dst+3
  281                         	  .endif
  282                         		;--- 4th byte, 4th MDS column = 5B 01 EF 5B
  283                         		Sbox8	srcB0+((rotCnt+step*3).AND.3),p1,p1,p0,key+3
  284                         	  .if USE_MDS_TAB
  285                         		stx	dst+2
  286                         	  .else
  287                         	    .if USE_ALPHA_TAB
  288                         		stx	tmp
  289                         		txa
  290                         		eor	dst+1
  291                         		sta	dst+1
  292                         		ldx	alpha,X
  293                         		stx	tmp+1		;tmp+1 = alpha**-1
  294                         		lda	alpha,X
  295                         	    .else
  296                         		sta	tmp		;save the 01 thing
  297                         		eor	dst+1
  298                         		sta	dst+1		;xor the 01
  299                         		lda	tmp
  300                         		mulAlpha
  301                         		sta	tmp+1
  302                         		mulAlpha
  303                         	    .endif
  304                         		eor	tmp		;now A = 5B
  305                         		tax			;save 5B in X
  306                         		eor	dst
  307                         		sta	dst
  Tue Jun 16 20:06:03 1998                                                                                               Page    7

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  308                         		txa			;A = 5B
  309                         		eor	dst+3
  310                         		sta	dst+3
  311                         		txa
  312                         		eor	tmp+1		;now A = EF
  313                         		eor	dst+2
  314                         		sta	dst+2
  315                         	  .endif
  316                         	  .if USE_MDS_TAB		;S-box outputs=[tmp,tmp+2,dst+3,dst+2]
  317                         		lda	tmp		;here with X = 4th S-box output
  318                         		eor	tab5B,X
  319                         		ldx	tmp+1
  320                         		eor	tabEF,X
  321                         		ldx	dst+3
  322                         		eor	tab5B,X
  323                         		sta	dst		;X=3rd S-box output now
  324                         	
  325                         		lda	dst+2
  326                         		eor	tabEF,X
  327                         		ldx	tmp
  328                         		eor	tab5B,X
  329                         		ldx	tmp+1
  330                         		eor	tabEF,X
  331                         		sta	dst+1		;X=2nd S-box output now
  332                         	
  333                         		lda	dst+3
  334                         		eor	tab5B,X
  335                         		ldx	tmp
  336                         		eor	tabEF,X
  337                         		ldx	dst+2
  338                         		eor	tabEF,X
  339                         		sta	dst+2
  340                         	
  341                         		lda	tmp+1
  342                         		eor	tab5B,X
  343                         		ldx	tmp
  344                         		eor	tabEF,X
  345                         		ldx	dst+3
  346                         		eor	tabEF,X
  347                         		sta	dst+3
  348                         	  .endif
  349                         	f32Size		.var $-tmpf32
  350                         	f32ByteCnt	.var f32ByteCnt+f32Size
  351                         		.endm
  352                         	
  353                         	
  354                         	op1	.macro	opCode,a,b
  355                         	tmpOp		.var $
  356                         		lda	a
  357                         		opCode	b
  358                         		sta	a
  359                         	tmpOp		.var $-tmpOp
  360                         	op1ByteCnt .var op1ByteCnt+tmpOp
  361                         		.endm
  362                         	
  363                         	op4	.macro	opCode1,opCode2,a,b
  364                         		op1	opCode1,a  ,b
  Tue Jun 16 20:06:03 1998                                                                                               Page    8

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  365                         		op1	opCode2,a+1,b+1
  366                         		op1	opCode2,a+2,b+2
  367                         		op1	opCode2,a+3,b+3
  368                         		.endm
  369                         	
  370                         	swap1	.macro	y,z
  371                         	tmpSwap		.var	$
  372                         		ldx	y
  373                         		lda	z
  374                         		stx	z
  375                         		sta	y
  376                         	tmpSwap		.var	$-tmpSwap
  377                         	swap1ByteCnt .var swap1ByteCnt+tmpSwap
  378                         		.endm
  379                         	
  380                         	swap4	.macro	y,z
  381                         		swap1	y  ,z
  382                         		swap1	y+1,z+1
  383                         		swap1	y+2,z+2
  384                         		swap1	y+3,z+3
  385                         		.endm
  386                         	
  387                         	mov4	.macro	src,dst
  388                         		lda	src
  389                         		sta	dst
  390                         		lda	src+1
  391                         		sta	dst+1
  392                         		lda	src+2
  393                         		sta	dst+2
  394                         		lda	src+3
  395                         		sta	dst+3
  396                         		.endm
  397                         	
  398                         	add4	.macro	a,b		;a=a+b (dword operation)
  399                         		op4	add,adc,a,b
  400                         		.endm
  401                         	
  402                         	add4_1	.macro	a,b		;add4, but assume A already == b[0]
  403                         		add	a		;(save one opcode, three clocks)
  404                         		sta	a
  405                         		op1	adc,a+1,b+1
  406                         		op1	adc,a+2,b+2
  407                         		op1	adc,a+3,b+3
  408                         		.endm
  409                         	
  410                         	xor4	.macro	a,b		;a=a^b (dword operation)
  411                         		op4	eor,eor,a,b
  412                         		.endm
  413                         	
  414                         	rol4_1	.macro	a
  415                         	tmpRot		.var $
  416                         		lda	a
  417                         		add	#80h		;set carry
  418                         		rol	a+1
  419                         		rol	a+2
  420                         		rol	a+3
  421                         		rol	a
  Tue Jun 16 20:06:03 1998                                                                                               Page    9

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  422                         	tmpRot		.var $-tmpRot
  423                         	rotByteCnt	.var rotByteCnt+tmpRot
  424                         		.endm
  425                         	
  426                         	ror4_1	.macro	a
  427                         	tmpRot		.var $
  428                         		lda	a+3
  429                         		lsra			;start the carry bit
  430                         		ror	a+2
  431                         		ror	a+1
  432                         		ror	a
  433                         		ror	a+3
  434                         	tmpRot		.var $-tmpRot
  435                         	rotByteCnt	.var rotByteCnt+tmpRot
  436                         		.endm
  437                         	
  438                         	;----------------------------------------------------------------
  439                         	; round xor function
  440                         	;
  441                         	RoundXor .macro
  442                         	  .if UNROLL_ROUND
  443                         		xor4	Text+8 ,t0
  444                         		xor4	Text+12,t1
  445                         	  .else
  446                         		jsr	rXor
  447                         	  .endif
  448                         	.endm
  449                         	
  450         [01]            	  .ife UNROLL_ROUND 
  451                         	rXor:	xor4	Text+8 ,t0
  452                         		xor4	Text+12,t1
  453                         		rts
  454         [00]            	  .endif
  455                         	
  456                         	
  457                         	;----------------------------------------------------------------
  458                         	; computeSubkey: compute subkey values sk0,sk1 from 
  459                         	;
  460                         	;   Input:	round	=	subkey number
  461                         	;   Output:	sk0,sk1	=	subkeys
  462                         	;		round incremented by two
  463                         	;		modifies sPtr also
  464                         	;----------------------------------------------------------------
  465                         	;
  466  01C5                   	computeSubkey:
  467         [01]            	.if UNROLL_SUBKEY
  468  01C5                   		f32	round,0,0,sk0,K32e
  469         01C5            	tmpf32		.var $
  470                         		;--- 1st byte, first MDS column = 01 5B EF EF
  471  01C5                   		Sbox8	round+((0+0*0).AND.3),p0,p0,p1,K32e
  472         01C5            	tmpS8		.var $
  473         [02]            	  .if K32e.lt.4			;use X as ä ptr?
  474         [03]            	      .if K32e.eq.0
  475                         		stx	sPtr
  476         [03]            	      .else
  477                         		ldx	sPtr
  478         [02]            	      .endif
  Tue Jun 16 20:06:03 1998                                                                                               Page   10

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  479                         		lda	K32e+KBUMP,X
  480                         		ldx	round+((0+0*0).AND.3)
  481                         		eor	p0,X
  482                         		tax
  483                         		lda	p0,X
  484                         		ldx	sPtr
  485                         		eor	K32e,X
  486         [02]            	  .else
  487  01C5   BE 89           		ldx	round+((0+0*0).AND.3)
  488  01C7   D6 06 5C        		lda	p0,X
  489  01CA   B8 6C           		eor	K32e+KBUMP
  490  01CC   97              		tax
  491  01CD   D6 06 5C        		lda	p0,X
  492  01D0   B8 60           		eor	K32e
  493         [01]            	  .endif
  494  01D2   97              		tax
  495         [02]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
  496  01D3   DE 07 5C        		ldx	p1,X		;return result in X
  497         [02]            	  .else
  498                         		lda	p1,X		;return result in A
  499         [01]            	  .endif
  500         0001            	Sbox8CallCnt	.var Sbox8CallCnt+1
  501         0011            	Sbox8Size	.var $-tmpS8
  502         0011            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
  503  01D6                   		.endm	
  504         [02]            	  .if USE_MDS_TAB
  505  01D6   BF 8A           		stx	tmp
  506         [02]            	  .else
  507         [03]            	    .if USE_ALPHA_TAB
  508                         		stx	sk0		;X = 01
  509                         		ldx	alpha,X
  510                         		stx	tmp+1
  511                         		lda	alpha,X
  512         [03]            	    .else 
  513                         		sta	sk0		;A = 01.  Store it
  514                         		mulAlpha		;a=a*alpha**-1
  515                         		sta	tmp+1
  516                         		mulAlpha
  517         [02]            	    .endif
  518                         		eor	sk0		;now A = 5B
  519                         		sta	sk0+1
  520                         		eor	tmp+1		;now A = EF
  521                         		sta	sk0+2
  522                         		sta	sk0+3
  523         [01]            	  .endif
  524                         		;--- 2nd byte, 2nd MDS column = EF EF 5B 01
  525  01D8                   		Sbox8	round+((0+0*1).AND.3),p1,p0,p0,K32e+1
  526         01D8            	tmpS8		.var $
  527         [02]            	  .if K32e+1.lt.4			;use X as ä ptr?
  528         [03]            	      .if K32e+1.eq.0
  529                         		stx	sPtr
  530         [03]            	      .else
  531                         		ldx	sPtr
  532         [02]            	      .endif
  533                         		lda	K32e+1+KBUMP,X
  534                         		ldx	round+((0+0*1).AND.3)
  535                         		eor	p1,X
  Tue Jun 16 20:06:03 1998                                                                                               Page   11

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  536                         		tax
  537                         		lda	p0,X
  538                         		ldx	sPtr
  539                         		eor	K32e+1,X
  540         [02]            	  .else
  541  01D8   BE 89           		ldx	round+((0+0*1).AND.3)
  542  01DA   D6 07 5C        		lda	p1,X
  543  01DD   B8 6D           		eor	K32e+1+KBUMP
  544  01DF   97              		tax
  545  01E0   D6 06 5C        		lda	p0,X
  546  01E3   B8 61           		eor	K32e+1
  547         [01]            	  .endif
  548  01E5   97              		tax
  549         [02]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
  550  01E6   DE 06 5C        		ldx	p0,X		;return result in X
  551         [02]            	  .else
  552                         		lda	p0,X		;return result in A
  553         [01]            	  .endif
  554         0002            	Sbox8CallCnt	.var Sbox8CallCnt+1
  555         0011            	Sbox8Size	.var $-tmpS8
  556         0022            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
  557  01E9                   		.endm	
  558         [02]            	  .if USE_MDS_TAB
  559  01E9   BF 8B           		stx	tmp+1
  560         [02]            	  .else
  561         [03]            	    .if USE_ALPHA_TAB
  562                         		stx	tmp
  563                         		txa
  564                         		eor	sk0+3
  565                         		sta	sk0+3
  566                         		ldx	alpha,X
  567                         		stx	tmp+1		;tmp+1 = alpha**-1
  568                         		lda	alpha,X
  569         [03]            	    .else
  570                         		sta	tmp		;save the 01 thing
  571                         		eor	sk0+3
  572                         		sta	sk0+3		;xor the 01
  573                         		lda	tmp
  574                         		mulAlpha
  575                         		sta	tmp+1
  576                         		mulAlpha
  577         [02]            	    .endif
  578                         		eor	tmp		;now A = 5B
  579                         		tax			;save 5B in X
  580                         		eor	sk0+2
  581                         		sta	sk0+2
  582                         		txa			;A = 5B
  583                         		eor	tmp+1		;now A = EF
  584                         		tax			;save 5F in X
  585                         		eor	sk0+1
  586                         		sta	sk0+1
  587                         		txa	
  588                         		eor	sk0
  589                         		sta	sk0
  590         [01]            	  .endif
  591                         		;--- 3rd byte, 3rd MDS column = 5B EF 01 EF
  592  01EB                   		Sbox8	round+((0+0*2).AND.3),p0,p1,p1,K32e+2
  Tue Jun 16 20:06:03 1998                                                                                               Page   12

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  593         01EB            	tmpS8		.var $
  594         [02]            	  .if K32e+2.lt.4			;use X as ä ptr?
  595         [03]            	      .if K32e+2.eq.0
  596                         		stx	sPtr
  597         [03]            	      .else
  598                         		ldx	sPtr
  599         [02]            	      .endif
  600                         		lda	K32e+2+KBUMP,X
  601                         		ldx	round+((0+0*2).AND.3)
  602                         		eor	p0,X
  603                         		tax
  604                         		lda	p1,X
  605                         		ldx	sPtr
  606                         		eor	K32e+2,X
  607         [02]            	  .else
  608  01EB   BE 89           		ldx	round+((0+0*2).AND.3)
  609  01ED   D6 06 5C        		lda	p0,X
  610  01F0   B8 6E           		eor	K32e+2+KBUMP
  611  01F2   97              		tax
  612  01F3   D6 07 5C        		lda	p1,X
  613  01F6   B8 62           		eor	K32e+2
  614         [01]            	  .endif
  615  01F8   97              		tax
  616         [02]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
  617  01F9   DE 07 5C        		ldx	p1,X		;return result in X
  618         [02]            	  .else
  619                         		lda	p1,X		;return result in A
  620         [01]            	  .endif
  621         0003            	Sbox8CallCnt	.var Sbox8CallCnt+1
  622         0011            	Sbox8Size	.var $-tmpS8
  623         0033            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
  624  01FC                   		.endm	
  625         [02]            	  .if USE_MDS_TAB
  626  01FC   BF 7B           		stx	sk0+3		;very careful ordering
  627         [02]            	  .else
  628         [03]            	    .if USE_ALPHA_TAB
  629                         		stx	sk0+2
  630                         		txa
  631                         		eor	sk0+2
  632                         		sta	sk0+2
  633                         		ldx	alpha,X
  634                         		stx	tmp+1		;tmp+1 = alpha**-1
  635                         		lda	alpha,X
  636         [03]            	    .else
  637                         		sta	tmp		;save the 01 thing
  638                         		eor	sk0+2
  639                         		sta	sk0+2		;xor the 01
  640                         		lda	tmp
  641                         		mulAlpha
  642                         		sta	tmp+1
  643                         		mulAlpha
  644         [02]            	    .endif
  645                         		eor	tmp		;now A = 5B
  646                         		tax			;save 5B in X
  647                         		eor	sk0
  648                         		sta	sk0
  649                         		txa			;A = 5B
  Tue Jun 16 20:06:03 1998                                                                                               Page   13

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  650                         		eor	tmp+1		;now A = EF
  651                         		tax			;save 5F in X
  652                         		eor	sk0+1
  653                         		sta	sk0+1
  654                         		txa	
  655                         		eor	sk0+3
  656                         		sta	sk0+3
  657         [01]            	  .endif
  658                         		;--- 4th byte, 4th MDS column = 5B 01 EF 5B
  659  01FE                   		Sbox8	round+((0+0*3).AND.3),p1,p1,p0,K32e+3
  660         01FE            	tmpS8		.var $
  661         [02]            	  .if K32e+3.lt.4			;use X as ä ptr?
  662         [03]            	      .if K32e+3.eq.0
  663                         		stx	sPtr
  664         [03]            	      .else
  665                         		ldx	sPtr
  666         [02]            	      .endif
  667                         		lda	K32e+3+KBUMP,X
  668                         		ldx	round+((0+0*3).AND.3)
  669                         		eor	p1,X
  670                         		tax
  671                         		lda	p1,X
  672                         		ldx	sPtr
  673                         		eor	K32e+3,X
  674         [02]            	  .else
  675  01FE   BE 89           		ldx	round+((0+0*3).AND.3)
  676  0200   D6 07 5C        		lda	p1,X
  677  0203   B8 6F           		eor	K32e+3+KBUMP
  678  0205   97              		tax
  679  0206   D6 07 5C        		lda	p1,X
  680  0209   B8 63           		eor	K32e+3
  681         [01]            	  .endif
  682  020B   97              		tax
  683         [02]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
  684  020C   DE 06 5C        		ldx	p0,X		;return result in X
  685         [02]            	  .else
  686                         		lda	p0,X		;return result in A
  687         [01]            	  .endif
  688         0004            	Sbox8CallCnt	.var Sbox8CallCnt+1
  689         0011            	Sbox8Size	.var $-tmpS8
  690         0044            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
  691  020F                   		.endm	
  692         [02]            	  .if USE_MDS_TAB
  693  020F   BF 7A           		stx	sk0+2
  694         [02]            	  .else
  695         [03]            	    .if USE_ALPHA_TAB
  696                         		stx	tmp
  697                         		txa
  698                         		eor	sk0+1
  699                         		sta	sk0+1
  700                         		ldx	alpha,X
  701                         		stx	tmp+1		;tmp+1 = alpha**-1
  702                         		lda	alpha,X
  703         [03]            	    .else
  704                         		sta	tmp		;save the 01 thing
  705                         		eor	sk0+1
  706                         		sta	sk0+1		;xor the 01
  Tue Jun 16 20:06:03 1998                                                                                               Page   14

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  707                         		lda	tmp
  708                         		mulAlpha
  709                         		sta	tmp+1
  710                         		mulAlpha
  711         [02]            	    .endif
  712                         		eor	tmp		;now A = 5B
  713                         		tax			;save 5B in X
  714                         		eor	sk0
  715                         		sta	sk0
  716                         		txa			;A = 5B
  717                         		eor	sk0+3
  718                         		sta	sk0+3
  719                         		txa
  720                         		eor	tmp+1		;now A = EF
  721                         		eor	sk0+2
  722                         		sta	sk0+2
  723         [01]            	  .endif
  724         [02]            	  .if USE_MDS_TAB		;S-box outputs=[tmp,tmp+2,â+3,â+2]
  725  0211   B6 8A           		lda	tmp		;here with X = 4th S-box output
  726  0213   D8 08 5C        		eor	tab5B,X
  727  0216   BE 8B           		ldx	tmp+1
  728  0218   D8 09 5C        		eor	tabEF,X
  729  021B   BE 7B           		ldx	sk0+3
  730  021D   D8 08 5C        		eor	tab5B,X
  731  0220   B7 78           		sta	sk0		;X=3rd S-box output now
  732                         	
  733  0222   B6 7A           		lda	sk0+2
  734  0224   D8 09 5C        		eor	tabEF,X
  735  0227   BE 8A           		ldx	tmp
  736  0229   D8 08 5C        		eor	tab5B,X
  737  022C   BE 8B           		ldx	tmp+1
  738  022E   D8 09 5C        		eor	tabEF,X
  739  0231   B7 79           		sta	sk0+1		;X=2nd S-box output now
  740                         	
  741  0233   B6 7B           		lda	sk0+3
  742  0235   D8 08 5C        		eor	tab5B,X
  743  0238   BE 8A           		ldx	tmp
  744  023A   D8 09 5C        		eor	tabEF,X
  745  023D   BE 7A           		ldx	sk0+2
  746  023F   D8 09 5C        		eor	tabEF,X
  747  0242   B7 7A           		sta	sk0+2
  748                         	
  749  0244   B6 8B           		lda	tmp+1
  750  0246   D8 08 5C        		eor	tab5B,X
  751  0249   BE 8A           		ldx	tmp
  752  024B   D8 09 5C        		eor	tabEF,X
  753  024E   BE 7B           		ldx	sk0+3
  754  0250   D8 09 5C        		eor	tabEF,X
  755  0253   B7 7B           		sta	sk0+3
  756         [01]            	  .endif
  757         0090            	f32Size		.var $-tmpf32
  758         0090            	f32ByteCnt	.var f32ByteCnt+f32Size
  759  0255                   		.endm
  760  0255   3C 89           		inc	round
  761  0257                   		f32	round,0,0,sk1+2,K32o
  762         0257            	tmpf32		.var $
  763                         		;--- 1st byte, first MDS column = 01 5B EF EF
  Tue Jun 16 20:06:03 1998                                                                                               Page   15

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  764  0257                   		Sbox8	round+((0+0*0).AND.3),p0,p0,p1,K32o
  765         0257            	tmpS8		.var $
  766         [02]            	  .if K32o.lt.4			;use X as ä ptr?
  767         [03]            	      .if K32o.eq.0
  768                         		stx	sPtr
  769         [03]            	      .else
  770                         		ldx	sPtr
  771         [02]            	      .endif
  772                         		lda	K32o+KBUMP,X
  773                         		ldx	round+((0+0*0).AND.3)
  774                         		eor	p0,X
  775                         		tax
  776                         		lda	p0,X
  777                         		ldx	sPtr
  778                         		eor	K32o,X
  779         [02]            	  .else
  780  0257   BE 89           		ldx	round+((0+0*0).AND.3)
  781  0259   D6 06 5C        		lda	p0,X
  782  025C   B8 70           		eor	K32o+KBUMP
  783  025E   97              		tax
  784  025F   D6 06 5C        		lda	p0,X
  785  0262   B8 64           		eor	K32o
  786         [01]            	  .endif
  787  0264   97              		tax
  788         [02]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
  789  0265   DE 07 5C        		ldx	p1,X		;return result in X
  790         [02]            	  .else
  791                         		lda	p1,X		;return result in A
  792         [01]            	  .endif
  793         0005            	Sbox8CallCnt	.var Sbox8CallCnt+1
  794         0011            	Sbox8Size	.var $-tmpS8
  795         0055            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
  796  0268                   		.endm	
  797         [02]            	  .if USE_MDS_TAB
  798  0268   BF 8A           		stx	tmp
  799         [02]            	  .else
  800         [03]            	    .if USE_ALPHA_TAB
  801                         		stx	sk1+2		;X = 01
  802                         		ldx	alpha,X
  803                         		stx	tmp+1
  804                         		lda	alpha,X
  805         [03]            	    .else 
  806                         		sta	sk1+2		;A = 01.  Store it
  807                         		mulAlpha		;a=a*alpha**-1
  808                         		sta	tmp+1
  809                         		mulAlpha
  810         [02]            	    .endif
  811                         		eor	sk1+2		;now A = 5B
  812                         		sta	sk1+2+1
  813                         		eor	tmp+1		;now A = EF
  814                         		sta	sk1+2+2
  815                         		sta	sk1+2+3
  816         [01]            	  .endif
  817                         		;--- 2nd byte, 2nd MDS column = EF EF 5B 01
  818  026A                   		Sbox8	round+((0+0*1).AND.3),p1,p0,p0,K32o+1
  819         026A            	tmpS8		.var $
  820         [02]            	  .if K32o+1.lt.4			;use X as ä ptr?
  Tue Jun 16 20:06:03 1998                                                                                               Page   16

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  821         [03]            	      .if K32o+1.eq.0
  822                         		stx	sPtr
  823         [03]            	      .else
  824                         		ldx	sPtr
  825         [02]            	      .endif
  826                         		lda	K32o+1+KBUMP,X
  827                         		ldx	round+((0+0*1).AND.3)
  828                         		eor	p1,X
  829                         		tax
  830                         		lda	p0,X
  831                         		ldx	sPtr
  832                         		eor	K32o+1,X
  833         [02]            	  .else
  834  026A   BE 89           		ldx	round+((0+0*1).AND.3)
  835  026C   D6 07 5C        		lda	p1,X
  836  026F   B8 71           		eor	K32o+1+KBUMP
  837  0271   97              		tax
  838  0272   D6 06 5C        		lda	p0,X
  839  0275   B8 65           		eor	K32o+1
  840         [01]            	  .endif
  841  0277   97              		tax
  842         [02]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
  843  0278   DE 06 5C        		ldx	p0,X		;return result in X
  844         [02]            	  .else
  845                         		lda	p0,X		;return result in A
  846         [01]            	  .endif
  847         0006            	Sbox8CallCnt	.var Sbox8CallCnt+1
  848         0011            	Sbox8Size	.var $-tmpS8
  849         0066            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
  850  027B                   		.endm	
  851         [02]            	  .if USE_MDS_TAB
  852  027B   BF 8B           		stx	tmp+1
  853         [02]            	  .else
  854         [03]            	    .if USE_ALPHA_TAB
  855                         		stx	tmp
  856                         		txa
  857                         		eor	sk1+2+3
  858                         		sta	sk1+2+3
  859                         		ldx	alpha,X
  860                         		stx	tmp+1		;tmp+1 = alpha**-1
  861                         		lda	alpha,X
  862         [03]            	    .else
  863                         		sta	tmp		;save the 01 thing
  864                         		eor	sk1+2+3
  865                         		sta	sk1+2+3		;xor the 01
  866                         		lda	tmp
  867                         		mulAlpha
  868                         		sta	tmp+1
  869                         		mulAlpha
  870         [02]            	    .endif
  871                         		eor	tmp		;now A = 5B
  872                         		tax			;save 5B in X
  873                         		eor	sk1+2+2
  874                         		sta	sk1+2+2
  875                         		txa			;A = 5B
  876                         		eor	tmp+1		;now A = EF
  877                         		tax			;save 5F in X
  Tue Jun 16 20:06:03 1998                                                                                               Page   17

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  878                         		eor	sk1+2+1
  879                         		sta	sk1+2+1
  880                         		txa	
  881                         		eor	sk1+2
  882                         		sta	sk1+2
  883         [01]            	  .endif
  884                         		;--- 3rd byte, 3rd MDS column = 5B EF 01 EF
  885  027D                   		Sbox8	round+((0+0*2).AND.3),p0,p1,p1,K32o+2
  886         027D            	tmpS8		.var $
  887         [02]            	  .if K32o+2.lt.4			;use X as ä ptr?
  888         [03]            	      .if K32o+2.eq.0
  889                         		stx	sPtr
  890         [03]            	      .else
  891                         		ldx	sPtr
  892         [02]            	      .endif
  893                         		lda	K32o+2+KBUMP,X
  894                         		ldx	round+((0+0*2).AND.3)
  895                         		eor	p0,X
  896                         		tax
  897                         		lda	p1,X
  898                         		ldx	sPtr
  899                         		eor	K32o+2,X
  900         [02]            	  .else
  901  027D   BE 89           		ldx	round+((0+0*2).AND.3)
  902  027F   D6 06 5C        		lda	p0,X
  903  0282   B8 72           		eor	K32o+2+KBUMP
  904  0284   97              		tax
  905  0285   D6 07 5C        		lda	p1,X
  906  0288   B8 66           		eor	K32o+2
  907         [01]            	  .endif
  908  028A   97              		tax
  909         [02]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
  910  028B   DE 07 5C        		ldx	p1,X		;return result in X
  911         [02]            	  .else
  912                         		lda	p1,X		;return result in A
  913         [01]            	  .endif
  914         0007            	Sbox8CallCnt	.var Sbox8CallCnt+1
  915         0011            	Sbox8Size	.var $-tmpS8
  916         0077            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
  917  028E                   		.endm	
  918         [02]            	  .if USE_MDS_TAB
  919  028E   BF 81           		stx	sk1+2+3		;very careful ordering
  920         [02]            	  .else
  921         [03]            	    .if USE_ALPHA_TAB
  922                         		stx	sk1+2+2
  923                         		txa
  924                         		eor	sk1+2+2
  925                         		sta	sk1+2+2
  926                         		ldx	alpha,X
  927                         		stx	tmp+1		;tmp+1 = alpha**-1
  928                         		lda	alpha,X
  929         [03]            	    .else
  930                         		sta	tmp		;save the 01 thing
  931                         		eor	sk1+2+2
  932                         		sta	sk1+2+2		;xor the 01
  933                         		lda	tmp
  934                         		mulAlpha
  Tue Jun 16 20:06:03 1998                                                                                               Page   18

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  935                         		sta	tmp+1
  936                         		mulAlpha
  937         [02]            	    .endif
  938                         		eor	tmp		;now A = 5B
  939                         		tax			;save 5B in X
  940                         		eor	sk1+2
  941                         		sta	sk1+2
  942                         		txa			;A = 5B
  943                         		eor	tmp+1		;now A = EF
  944                         		tax			;save 5F in X
  945                         		eor	sk1+2+1
  946                         		sta	sk1+2+1
  947                         		txa	
  948                         		eor	sk1+2+3
  949                         		sta	sk1+2+3
  950         [01]            	  .endif
  951                         		;--- 4th byte, 4th MDS column = 5B 01 EF 5B
  952  0290                   		Sbox8	round+((0+0*3).AND.3),p1,p1,p0,K32o+3
  953         0290            	tmpS8		.var $
  954         [02]            	  .if K32o+3.lt.4			;use X as ä ptr?
  955         [03]            	      .if K32o+3.eq.0
  956                         		stx	sPtr
  957         [03]            	      .else
  958                         		ldx	sPtr
  959         [02]            	      .endif
  960                         		lda	K32o+3+KBUMP,X
  961                         		ldx	round+((0+0*3).AND.3)
  962                         		eor	p1,X
  963                         		tax
  964                         		lda	p1,X
  965                         		ldx	sPtr
  966                         		eor	K32o+3,X
  967         [02]            	  .else
  968  0290   BE 89           		ldx	round+((0+0*3).AND.3)
  969  0292   D6 07 5C        		lda	p1,X
  970  0295   B8 73           		eor	K32o+3+KBUMP
  971  0297   97              		tax
  972  0298   D6 07 5C        		lda	p1,X
  973  029B   B8 67           		eor	K32o+3
  974         [01]            	  .endif
  975  029D   97              		tax
  976         [02]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
  977  029E   DE 06 5C        		ldx	p0,X		;return result in X
  978         [02]            	  .else
  979                         		lda	p0,X		;return result in A
  980         [01]            	  .endif
  981         0008            	Sbox8CallCnt	.var Sbox8CallCnt+1
  982         0011            	Sbox8Size	.var $-tmpS8
  983         0088            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
  984  02A1                   		.endm	
  985         [02]            	  .if USE_MDS_TAB
  986  02A1   BF 80           		stx	sk1+2+2
  987         [02]            	  .else
  988         [03]            	    .if USE_ALPHA_TAB
  989                         		stx	tmp
  990                         		txa
  991                         		eor	sk1+2+1
  Tue Jun 16 20:06:03 1998                                                                                               Page   19

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

  992                         		sta	sk1+2+1
  993                         		ldx	alpha,X
  994                         		stx	tmp+1		;tmp+1 = alpha**-1
  995                         		lda	alpha,X
  996         [03]            	    .else
  997                         		sta	tmp		;save the 01 thing
  998                         		eor	sk1+2+1
  999                         		sta	sk1+2+1		;xor the 01
 1000                         		lda	tmp
 1001                         		mulAlpha
 1002                         		sta	tmp+1
 1003                         		mulAlpha
 1004         [02]            	    .endif
 1005                         		eor	tmp		;now A = 5B
 1006                         		tax			;save 5B in X
 1007                         		eor	sk1+2
 1008                         		sta	sk1+2
 1009                         		txa			;A = 5B
 1010                         		eor	sk1+2+3
 1011                         		sta	sk1+2+3
 1012                         		txa
 1013                         		eor	tmp+1		;now A = EF
 1014                         		eor	sk1+2+2
 1015                         		sta	sk1+2+2
 1016         [01]            	  .endif
 1017         [02]            	  .if USE_MDS_TAB		;S-box outputs=[tmp,tmp+2,â+3,â+2]
 1018  02A3   B6 8A           		lda	tmp		;here with X = 4th S-box output
 1019  02A5   D8 08 5C        		eor	tab5B,X
 1020  02A8   BE 8B           		ldx	tmp+1
 1021  02AA   D8 09 5C        		eor	tabEF,X
 1022  02AD   BE 81           		ldx	sk1+2+3
 1023  02AF   D8 08 5C        		eor	tab5B,X
 1024  02B2   B7 7E           		sta	sk1+2		;X=3rd S-box output now
 1025                         	
 1026  02B4   B6 80           		lda	sk1+2+2
 1027  02B6   D8 09 5C        		eor	tabEF,X
 1028  02B9   BE 8A           		ldx	tmp
 1029  02BB   D8 08 5C        		eor	tab5B,X
 1030  02BE   BE 8B           		ldx	tmp+1
 1031  02C0   D8 09 5C        		eor	tabEF,X
 1032  02C3   B7 7F           		sta	sk1+2+1		;X=2nd S-box output now
 1033                         	
 1034  02C5   B6 81           		lda	sk1+2+3
 1035  02C7   D8 08 5C        		eor	tab5B,X
 1036  02CA   BE 8A           		ldx	tmp
 1037  02CC   D8 09 5C        		eor	tabEF,X
 1038  02CF   BE 80           		ldx	sk1+2+2
 1039  02D1   D8 09 5C        		eor	tabEF,X
 1040  02D4   B7 80           		sta	sk1+2+2
 1041                         	
 1042  02D6   B6 8B           		lda	tmp+1
 1043  02D8   D8 08 5C        		eor	tab5B,X
 1044  02DB   BE 8A           		ldx	tmp
 1045  02DD   D8 09 5C        		eor	tabEF,X
 1046  02E0   BE 81           		ldx	sk1+2+3
 1047  02E2   D8 09 5C        		eor	tabEF,X
 1048  02E5   B7 81           		sta	sk1+2+3
  Tue Jun 16 20:06:03 1998                                                                                               Page   20

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1049         [01]            	  .endif
 1050         0090            	f32Size		.var $-tmpf32
 1051         0120            	f32ByteCnt	.var f32ByteCnt+f32Size
 1052  02E7                   		.endm
 1053  02E7   3C 89           		inc	round
 1054         [01]            	.else	; just use one f32 invocation, copy result and loop
 1055                         		ldx	#K32e
 1056                         	skLoop:	f32	round,0,0,sk1+2,0;0 as key ptr --> use X
 1057                         		inc	round
 1058                         		brclr	0,round,f32Done
 1059                         		mov4	sk1+2,sk0	;move the result to sk0
 1060                         		ldx	#K32o		;use other one
 1061                         		jmp	skLoop
 1062                         	f32Done:	
 1063         [00]            	.endif
 1064         [01]            	   .if (sk1+4)-t0		;assert(sk1+4 == t0)
 1065                         		error	;!!
 1066         [00]            	   .endif
 1067  02E9   B6 81           		lda	sk1+5		;handle the ROL(sk1,8)
 1068  02EB   B7 7D           		sta	sk1+1
 1069  02ED                   		add4_1	sk0,sk1+1	;do the PHT
 1070  02ED   BB 78           		add	sk0		;(save one opcode, three clocks)
 1071  02EF   B7 78           		sta	sk0
 1072  02F1                   		op1	adc,sk0+1,sk1+1+1
 1073         02F1            	tmpOp		.var $
 1074  02F1   B6 79           		lda	sk0+1
 1075  02F3   B9 7E           		adc	sk1+1+1
 1076  02F5   B7 79           		sta	sk0+1
 1077         0006            	tmpOp		.var $-tmpOp
 1078         0006            	op1ByteCnt .var op1ByteCnt+tmpOp
 1079  02F7                   		.endm
 1080  02F7                   		op1	adc,sk0+2,sk1+1+2
 1081         02F7            	tmpOp		.var $
 1082  02F7   B6 7A           		lda	sk0+2
 1083  02F9   B9 7F           		adc	sk1+1+2
 1084  02FB   B7 7A           		sta	sk0+2
 1085         0006            	tmpOp		.var $-tmpOp
 1086         000C            	op1ByteCnt .var op1ByteCnt+tmpOp
 1087  02FD                   		.endm
 1088  02FD                   		op1	adc,sk0+3,sk1+1+3
 1089         02FD            	tmpOp		.var $
 1090  02FD   B6 7B           		lda	sk0+3
 1091  02FF   B9 80           		adc	sk1+1+3
 1092  0301   B7 7B           		sta	sk0+3
 1093         0006            	tmpOp		.var $-tmpOp
 1094         0012            	op1ByteCnt .var op1ByteCnt+tmpOp
 1095  0303                   		.endm
 1096  0303                   		.endm
 1097  0303                   		add4	sk1+1,sk0
 1098  0303                   		op4	add,adc,sk1+1,sk0
 1099  0303                   		op1	add,sk1+1  ,sk0
 1100         0303            	tmpOp		.var $
 1101  0303   B6 7D           		lda	sk1+1
 1102  0305   BB 78           		add	sk0
 1103  0307   B7 7D           		sta	sk1+1
 1104         0006            	tmpOp		.var $-tmpOp
 1105         0018            	op1ByteCnt .var op1ByteCnt+tmpOp
  Tue Jun 16 20:06:03 1998                                                                                               Page   21

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1106  0309                   		.endm
 1107  0309                   		op1	adc,sk1+1+1,sk0+1
 1108         0309            	tmpOp		.var $
 1109  0309   B6 7E           		lda	sk1+1+1
 1110  030B   B9 79           		adc	sk0+1
 1111  030D   B7 7E           		sta	sk1+1+1
 1112         0006            	tmpOp		.var $-tmpOp
 1113         001E            	op1ByteCnt .var op1ByteCnt+tmpOp
 1114  030F                   		.endm
 1115  030F                   		op1	adc,sk1+1+2,sk0+2
 1116         030F            	tmpOp		.var $
 1117  030F   B6 7F           		lda	sk1+1+2
 1118  0311   B9 7A           		adc	sk0+2
 1119  0313   B7 7F           		sta	sk1+1+2
 1120         0006            	tmpOp		.var $-tmpOp
 1121         0024            	op1ByteCnt .var op1ByteCnt+tmpOp
 1122  0315                   		.endm
 1123  0315                   		op1	adc,sk1+1+3,sk0+3
 1124         0315            	tmpOp		.var $
 1125  0315   B6 80           		lda	sk1+1+3
 1126  0317   B9 7B           		adc	sk0+3
 1127  0319   B7 80           		sta	sk1+1+3
 1128         0006            	tmpOp		.var $-tmpOp
 1129         002A            	op1ByteCnt .var op1ByteCnt+tmpOp
 1130  031B                   		.endm
 1131  031B                   		.endm
 1132  031B                   		.endm
 1133  031B                   		
 1134                         	;	lda	sk1+4		;handle ROL(A+2*B,9) ;; already set from add
 1135  031B   48              		lsla			;set the carry bit
 1136  031C   39 7D           		rol	sk1+1		;propagate through
 1137  031E   39 7E           		rol	sk1+2
 1138  0320   39 7F           		rol	sk1+3
 1139  0322   A9 00           		adc	#0		;merge in new carry
 1140  0324   B7 7C           		sta	sk1		;and store result
 1141                         	
 1142  0326   81              		rts
 1143         0162            	subkeyByteCnt	.var	$-computeSubkey
 1144                         	
 1145                         	;
 1146                         	;----------------------------------------------------------------
 1147                         	; roundFunc
 1148                         	;
 1149                         	;   Input:	round	=	subkey index
 1150                         	;		Text	=	text to process
 1151                         	;   Output:	t0,t1 computed
 1152                         	;----------------------------------------------------------------
 1153                         	;
 1154  0327                   	roundSwap:
 1155  0327                   		swap4	Text  ,Text+8
 1156  0327                   		swap1	Text  ,Text+8
 1157         0327            	tmpSwap		.var	$
 1158  0327   BE 50           		ldx	Text
 1159  0329   B6 58           		lda	Text+8
 1160  032B   BF 58           		stx	Text+8
 1161  032D   B7 50           		sta	Text
 1162         0008            	tmpSwap		.var	$-tmpSwap
  Tue Jun 16 20:06:03 1998                                                                                               Page   22

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1163         0008            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
 1164  032F                   		.endm
 1165  032F                   		swap1	Text+1,Text+8+1
 1166         032F            	tmpSwap		.var	$
 1167  032F   BE 51           		ldx	Text+1
 1168  0331   B6 59           		lda	Text+8+1
 1169  0333   BF 59           		stx	Text+8+1
 1170  0335   B7 51           		sta	Text+1
 1171         0008            	tmpSwap		.var	$-tmpSwap
 1172         0010            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
 1173  0337                   		.endm
 1174  0337                   		swap1	Text+2,Text+8+2
 1175         0337            	tmpSwap		.var	$
 1176  0337   BE 52           		ldx	Text+2
 1177  0339   B6 5A           		lda	Text+8+2
 1178  033B   BF 5A           		stx	Text+8+2
 1179  033D   B7 52           		sta	Text+2
 1180         0008            	tmpSwap		.var	$-tmpSwap
 1181         0018            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
 1182  033F                   		.endm
 1183  033F                   		swap1	Text+3,Text+8+3
 1184         033F            	tmpSwap		.var	$
 1185  033F   BE 53           		ldx	Text+3
 1186  0341   B6 5B           		lda	Text+8+3
 1187  0343   BF 5B           		stx	Text+8+3
 1188  0345   B7 53           		sta	Text+3
 1189         0008            	tmpSwap		.var	$-tmpSwap
 1190         0020            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
 1191  0347                   		.endm
 1192  0347                   		.endm
 1193  0347                   		swap4	Text+4,Text+12
 1194  0347                   		swap1	Text+4  ,Text+12
 1195         0347            	tmpSwap		.var	$
 1196  0347   BE 54           		ldx	Text+4
 1197  0349   B6 5C           		lda	Text+12
 1198  034B   BF 5C           		stx	Text+12
 1199  034D   B7 54           		sta	Text+4
 1200         0008            	tmpSwap		.var	$-tmpSwap
 1201         0028            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
 1202  034F                   		.endm
 1203  034F                   		swap1	Text+4+1,Text+12+1
 1204         034F            	tmpSwap		.var	$
 1205  034F   BE 55           		ldx	Text+4+1
 1206  0351   B6 5D           		lda	Text+12+1
 1207  0353   BF 5D           		stx	Text+12+1
 1208  0355   B7 55           		sta	Text+4+1
 1209         0008            	tmpSwap		.var	$-tmpSwap
 1210         0030            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
 1211  0357                   		.endm
 1212  0357                   		swap1	Text+4+2,Text+12+2
 1213         0357            	tmpSwap		.var	$
 1214  0357   BE 56           		ldx	Text+4+2
 1215  0359   B6 5E           		lda	Text+12+2
 1216  035B   BF 5E           		stx	Text+12+2
 1217  035D   B7 56           		sta	Text+4+2
 1218         0008            	tmpSwap		.var	$-tmpSwap
 1219         0038            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
  Tue Jun 16 20:06:03 1998                                                                                               Page   23

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1220  035F                   		.endm
 1221  035F                   		swap1	Text+4+3,Text+12+3
 1222         035F            	tmpSwap		.var	$
 1223  035F   BE 57           		ldx	Text+4+3
 1224  0361   B6 5F           		lda	Text+12+3
 1225  0363   BF 5F           		stx	Text+12+3
 1226  0365   B7 57           		sta	Text+4+3
 1227         0008            	tmpSwap		.var	$-tmpSwap
 1228         0040            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
 1229  0367                   		.endm
 1230  0367                   		.endm
 1231  0367                   	roundFunc:
 1232                         		; compute the round keys first (so we can use t0/t1 as tmps)
 1233  0367   CD 01 C5        		jsr	computeSubkey
 1234                         	;
 1235  036A                   		f32	Text  ,0,1,t0,SboxKey
 1236         036A            	tmpf32		.var $
 1237                         		;--- 1st byte, first MDS column = 01 5B EF EF
 1238  036A                   		Sbox8	Text+((0+1*0).AND.3),p0,p0,p1,SboxKey
 1239         036A            	tmpS8		.var $
 1240         [01]            	  .if SboxKey.lt.4			;use X as ä ptr?
 1241         [02]            	      .if SboxKey.eq.0
 1242                         		stx	sPtr
 1243         [02]            	      .else
 1244                         		ldx	sPtr
 1245         [01]            	      .endif
 1246                         		lda	SboxKey+KBUMP,X
 1247                         		ldx	Text+((0+1*0).AND.3)
 1248                         		eor	p0,X
 1249                         		tax
 1250                         		lda	p0,X
 1251                         		ldx	sPtr
 1252                         		eor	SboxKey,X
 1253         [01]            	  .else
 1254  036A   BE 50           		ldx	Text+((0+1*0).AND.3)
 1255  036C   D6 06 5C        		lda	p0,X
 1256  036F   B8 74           		eor	SboxKey+KBUMP
 1257  0371   97              		tax
 1258  0372   D6 06 5C        		lda	p0,X
 1259  0375   B8 68           		eor	SboxKey
 1260         [00]            	  .endif
 1261  0377   97              		tax
 1262         [01]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
 1263  0378   DE 07 5C        		ldx	p1,X		;return result in X
 1264         [01]            	  .else
 1265                         		lda	p1,X		;return result in A
 1266         [00]            	  .endif
 1267         0009            	Sbox8CallCnt	.var Sbox8CallCnt+1
 1268         0011            	Sbox8Size	.var $-tmpS8
 1269         0099            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
 1270  037B                   		.endm	
 1271         [01]            	  .if USE_MDS_TAB
 1272  037B   BF 8A           		stx	tmp
 1273         [01]            	  .else
 1274         [02]            	    .if USE_ALPHA_TAB
 1275                         		stx	t0		;X = 01
 1276                         		ldx	alpha,X
  Tue Jun 16 20:06:03 1998                                                                                               Page   24

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1277                         		stx	tmp+1
 1278                         		lda	alpha,X
 1279         [02]            	    .else 
 1280                         		sta	t0		;A = 01.  Store it
 1281                         		mulAlpha		;a=a*alpha**-1
 1282                         		sta	tmp+1
 1283                         		mulAlpha
 1284         [01]            	    .endif
 1285                         		eor	t0		;now A = 5B
 1286                         		sta	t0+1
 1287                         		eor	tmp+1		;now A = EF
 1288                         		sta	t0+2
 1289                         		sta	t0+3
 1290         [00]            	  .endif
 1291                         		;--- 2nd byte, 2nd MDS column = EF EF 5B 01
 1292  037D                   		Sbox8	Text+((0+1*1).AND.3),p1,p0,p0,SboxKey+1
 1293         037D            	tmpS8		.var $
 1294         [01]            	  .if SboxKey+1.lt.4			;use X as ä ptr?
 1295         [02]            	      .if SboxKey+1.eq.0
 1296                         		stx	sPtr
 1297         [02]            	      .else
 1298                         		ldx	sPtr
 1299         [01]            	      .endif
 1300                         		lda	SboxKey+1+KBUMP,X
 1301                         		ldx	Text+((0+1*1).AND.3)
 1302                         		eor	p1,X
 1303                         		tax
 1304                         		lda	p0,X
 1305                         		ldx	sPtr
 1306                         		eor	SboxKey+1,X
 1307         [01]            	  .else
 1308  037D   BE 51           		ldx	Text+((0+1*1).AND.3)
 1309  037F   D6 07 5C        		lda	p1,X
 1310  0382   B8 75           		eor	SboxKey+1+KBUMP
 1311  0384   97              		tax
 1312  0385   D6 06 5C        		lda	p0,X
 1313  0388   B8 69           		eor	SboxKey+1
 1314         [00]            	  .endif
 1315  038A   97              		tax
 1316         [01]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
 1317  038B   DE 06 5C        		ldx	p0,X		;return result in X
 1318         [01]            	  .else
 1319                         		lda	p0,X		;return result in A
 1320         [00]            	  .endif
 1321         000A            	Sbox8CallCnt	.var Sbox8CallCnt+1
 1322         0011            	Sbox8Size	.var $-tmpS8
 1323         00AA            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
 1324  038E                   		.endm	
 1325         [01]            	  .if USE_MDS_TAB
 1326  038E   BF 8B           		stx	tmp+1
 1327         [01]            	  .else
 1328         [02]            	    .if USE_ALPHA_TAB
 1329                         		stx	tmp
 1330                         		txa
 1331                         		eor	t0+3
 1332                         		sta	t0+3
 1333                         		ldx	alpha,X
  Tue Jun 16 20:06:03 1998                                                                                               Page   25

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1334                         		stx	tmp+1		;tmp+1 = alpha**-1
 1335                         		lda	alpha,X
 1336         [02]            	    .else
 1337                         		sta	tmp		;save the 01 thing
 1338                         		eor	t0+3
 1339                         		sta	t0+3		;xor the 01
 1340                         		lda	tmp
 1341                         		mulAlpha
 1342                         		sta	tmp+1
 1343                         		mulAlpha
 1344         [01]            	    .endif
 1345                         		eor	tmp		;now A = 5B
 1346                         		tax			;save 5B in X
 1347                         		eor	t0+2
 1348                         		sta	t0+2
 1349                         		txa			;A = 5B
 1350                         		eor	tmp+1		;now A = EF
 1351                         		tax			;save 5F in X
 1352                         		eor	t0+1
 1353                         		sta	t0+1
 1354                         		txa	
 1355                         		eor	t0
 1356                         		sta	t0
 1357         [00]            	  .endif
 1358                         		;--- 3rd byte, 3rd MDS column = 5B EF 01 EF
 1359  0390                   		Sbox8	Text+((0+1*2).AND.3),p0,p1,p1,SboxKey+2
 1360         0390            	tmpS8		.var $
 1361         [01]            	  .if SboxKey+2.lt.4			;use X as ä ptr?
 1362         [02]            	      .if SboxKey+2.eq.0
 1363                         		stx	sPtr
 1364         [02]            	      .else
 1365                         		ldx	sPtr
 1366         [01]            	      .endif
 1367                         		lda	SboxKey+2+KBUMP,X
 1368                         		ldx	Text+((0+1*2).AND.3)
 1369                         		eor	p0,X
 1370                         		tax
 1371                         		lda	p1,X
 1372                         		ldx	sPtr
 1373                         		eor	SboxKey+2,X
 1374         [01]            	  .else
 1375  0390   BE 52           		ldx	Text+((0+1*2).AND.3)
 1376  0392   D6 06 5C        		lda	p0,X
 1377  0395   B8 76           		eor	SboxKey+2+KBUMP
 1378  0397   97              		tax
 1379  0398   D6 07 5C        		lda	p1,X
 1380  039B   B8 6A           		eor	SboxKey+2
 1381         [00]            	  .endif
 1382  039D   97              		tax
 1383         [01]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
 1384  039E   DE 07 5C        		ldx	p1,X		;return result in X
 1385         [01]            	  .else
 1386                         		lda	p1,X		;return result in A
 1387         [00]            	  .endif
 1388         000B            	Sbox8CallCnt	.var Sbox8CallCnt+1
 1389         0011            	Sbox8Size	.var $-tmpS8
 1390         00BB            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
  Tue Jun 16 20:06:03 1998                                                                                               Page   26

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1391  03A1                   		.endm	
 1392         [01]            	  .if USE_MDS_TAB
 1393  03A1   BF 83           		stx	t0+3		;very careful ordering
 1394         [01]            	  .else
 1395         [02]            	    .if USE_ALPHA_TAB
 1396                         		stx	t0+2
 1397                         		txa
 1398                         		eor	t0+2
 1399                         		sta	t0+2
 1400                         		ldx	alpha,X
 1401                         		stx	tmp+1		;tmp+1 = alpha**-1
 1402                         		lda	alpha,X
 1403         [02]            	    .else
 1404                         		sta	tmp		;save the 01 thing
 1405                         		eor	t0+2
 1406                         		sta	t0+2		;xor the 01
 1407                         		lda	tmp
 1408                         		mulAlpha
 1409                         		sta	tmp+1
 1410                         		mulAlpha
 1411         [01]            	    .endif
 1412                         		eor	tmp		;now A = 5B
 1413                         		tax			;save 5B in X
 1414                         		eor	t0
 1415                         		sta	t0
 1416                         		txa			;A = 5B
 1417                         		eor	tmp+1		;now A = EF
 1418                         		tax			;save 5F in X
 1419                         		eor	t0+1
 1420                         		sta	t0+1
 1421                         		txa	
 1422                         		eor	t0+3
 1423                         		sta	t0+3
 1424         [00]            	  .endif
 1425                         		;--- 4th byte, 4th MDS column = 5B 01 EF 5B
 1426  03A3                   		Sbox8	Text+((0+1*3).AND.3),p1,p1,p0,SboxKey+3
 1427         03A3            	tmpS8		.var $
 1428         [01]            	  .if SboxKey+3.lt.4			;use X as ä ptr?
 1429         [02]            	      .if SboxKey+3.eq.0
 1430                         		stx	sPtr
 1431         [02]            	      .else
 1432                         		ldx	sPtr
 1433         [01]            	      .endif
 1434                         		lda	SboxKey+3+KBUMP,X
 1435                         		ldx	Text+((0+1*3).AND.3)
 1436                         		eor	p1,X
 1437                         		tax
 1438                         		lda	p1,X
 1439                         		ldx	sPtr
 1440                         		eor	SboxKey+3,X
 1441         [01]            	  .else
 1442  03A3   BE 53           		ldx	Text+((0+1*3).AND.3)
 1443  03A5   D6 07 5C        		lda	p1,X
 1444  03A8   B8 77           		eor	SboxKey+3+KBUMP
 1445  03AA   97              		tax
 1446  03AB   D6 07 5C        		lda	p1,X
 1447  03AE   B8 6B           		eor	SboxKey+3
  Tue Jun 16 20:06:03 1998                                                                                               Page   27

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1448         [00]            	  .endif
 1449  03B0   97              		tax
 1450         [01]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
 1451  03B1   DE 06 5C        		ldx	p0,X		;return result in X
 1452         [01]            	  .else
 1453                         		lda	p0,X		;return result in A
 1454         [00]            	  .endif
 1455         000C            	Sbox8CallCnt	.var Sbox8CallCnt+1
 1456         0011            	Sbox8Size	.var $-tmpS8
 1457         00CC            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
 1458  03B4                   		.endm	
 1459         [01]            	  .if USE_MDS_TAB
 1460  03B4   BF 82           		stx	t0+2
 1461         [01]            	  .else
 1462         [02]            	    .if USE_ALPHA_TAB
 1463                         		stx	tmp
 1464                         		txa
 1465                         		eor	t0+1
 1466                         		sta	t0+1
 1467                         		ldx	alpha,X
 1468                         		stx	tmp+1		;tmp+1 = alpha**-1
 1469                         		lda	alpha,X
 1470         [02]            	    .else
 1471                         		sta	tmp		;save the 01 thing
 1472                         		eor	t0+1
 1473                         		sta	t0+1		;xor the 01
 1474                         		lda	tmp
 1475                         		mulAlpha
 1476                         		sta	tmp+1
 1477                         		mulAlpha
 1478         [01]            	    .endif
 1479                         		eor	tmp		;now A = 5B
 1480                         		tax			;save 5B in X
 1481                         		eor	t0
 1482                         		sta	t0
 1483                         		txa			;A = 5B
 1484                         		eor	t0+3
 1485                         		sta	t0+3
 1486                         		txa
 1487                         		eor	tmp+1		;now A = EF
 1488                         		eor	t0+2
 1489                         		sta	t0+2
 1490         [00]            	  .endif
 1491         [01]            	  .if USE_MDS_TAB		;S-box outputs=[tmp,tmp+2,â+3,â+2]
 1492  03B6   B6 8A           		lda	tmp		;here with X = 4th S-box output
 1493  03B8   D8 08 5C        		eor	tab5B,X
 1494  03BB   BE 8B           		ldx	tmp+1
 1495  03BD   D8 09 5C        		eor	tabEF,X
 1496  03C0   BE 83           		ldx	t0+3
 1497  03C2   D8 08 5C        		eor	tab5B,X
 1498  03C5   B7 80           		sta	t0		;X=3rd S-box output now
 1499                         	
 1500  03C7   B6 82           		lda	t0+2
 1501  03C9   D8 09 5C        		eor	tabEF,X
 1502  03CC   BE 8A           		ldx	tmp
 1503  03CE   D8 08 5C        		eor	tab5B,X
 1504  03D1   BE 8B           		ldx	tmp+1
  Tue Jun 16 20:06:03 1998                                                                                               Page   28

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1505  03D3   D8 09 5C        		eor	tabEF,X
 1506  03D6   B7 81           		sta	t0+1		;X=2nd S-box output now
 1507                         	
 1508  03D8   B6 83           		lda	t0+3
 1509  03DA   D8 08 5C        		eor	tab5B,X
 1510  03DD   BE 8A           		ldx	tmp
 1511  03DF   D8 09 5C        		eor	tabEF,X
 1512  03E2   BE 82           		ldx	t0+2
 1513  03E4   D8 09 5C        		eor	tabEF,X
 1514  03E7   B7 82           		sta	t0+2
 1515                         	
 1516  03E9   B6 8B           		lda	tmp+1
 1517  03EB   D8 08 5C        		eor	tab5B,X
 1518  03EE   BE 8A           		ldx	tmp
 1519  03F0   D8 09 5C        		eor	tabEF,X
 1520  03F3   BE 83           		ldx	t0+3
 1521  03F5   D8 09 5C        		eor	tabEF,X
 1522  03F8   B7 83           		sta	t0+3
 1523         [00]            	  .endif
 1524         0090            	f32Size		.var $-tmpf32
 1525         01B0            	f32ByteCnt	.var f32ByteCnt+f32Size
 1526  03FA                   		.endm
 1527  03FA                   		f32	Text+4,3,1,t1,SboxKey
 1528         03FA            	tmpf32		.var $
 1529                         		;--- 1st byte, first MDS column = 01 5B EF EF
 1530  03FA                   		Sbox8	Text+4+((3+1*0).AND.3),p0,p0,p1,SboxKey
 1531         03FA            	tmpS8		.var $
 1532         [01]            	  .if SboxKey.lt.4			;use X as ä ptr?
 1533         [02]            	      .if SboxKey.eq.0
 1534                         		stx	sPtr
 1535         [02]            	      .else
 1536                         		ldx	sPtr
 1537         [01]            	      .endif
 1538                         		lda	SboxKey+KBUMP,X
 1539                         		ldx	Text+4+((3+1*0).AND.3)
 1540                         		eor	p0,X
 1541                         		tax
 1542                         		lda	p0,X
 1543                         		ldx	sPtr
 1544                         		eor	SboxKey,X
 1545         [01]            	  .else
 1546  03FA   BE 57           		ldx	Text+4+((3+1*0).AND.3)
 1547  03FC   D6 06 5C        		lda	p0,X
 1548  03FF   B8 74           		eor	SboxKey+KBUMP
 1549  0401   97              		tax
 1550  0402   D6 06 5C        		lda	p0,X
 1551  0405   B8 68           		eor	SboxKey
 1552         [00]            	  .endif
 1553  0407   97              		tax
 1554         [01]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
 1555  0408   DE 07 5C        		ldx	p1,X		;return result in X
 1556         [01]            	  .else
 1557                         		lda	p1,X		;return result in A
 1558         [00]            	  .endif
 1559         000D            	Sbox8CallCnt	.var Sbox8CallCnt+1
 1560         0011            	Sbox8Size	.var $-tmpS8
 1561         00DD            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
  Tue Jun 16 20:06:03 1998                                                                                               Page   29

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1562  040B                   		.endm	
 1563         [01]            	  .if USE_MDS_TAB
 1564  040B   BF 8A           		stx	tmp
 1565         [01]            	  .else
 1566         [02]            	    .if USE_ALPHA_TAB
 1567                         		stx	t1		;X = 01
 1568                         		ldx	alpha,X
 1569                         		stx	tmp+1
 1570                         		lda	alpha,X
 1571         [02]            	    .else 
 1572                         		sta	t1		;A = 01.  Store it
 1573                         		mulAlpha		;a=a*alpha**-1
 1574                         		sta	tmp+1
 1575                         		mulAlpha
 1576         [01]            	    .endif
 1577                         		eor	t1		;now A = 5B
 1578                         		sta	t1+1
 1579                         		eor	tmp+1		;now A = EF
 1580                         		sta	t1+2
 1581                         		sta	t1+3
 1582         [00]            	  .endif
 1583                         		;--- 2nd byte, 2nd MDS column = EF EF 5B 01
 1584  040D                   		Sbox8	Text+4+((3+1*1).AND.3),p1,p0,p0,SboxKey+1
 1585         040D            	tmpS8		.var $
 1586         [01]            	  .if SboxKey+1.lt.4			;use X as ä ptr?
 1587         [02]            	      .if SboxKey+1.eq.0
 1588                         		stx	sPtr
 1589         [02]            	      .else
 1590                         		ldx	sPtr
 1591         [01]            	      .endif
 1592                         		lda	SboxKey+1+KBUMP,X
 1593                         		ldx	Text+4+((3+1*1).AND.3)
 1594                         		eor	p1,X
 1595                         		tax
 1596                         		lda	p0,X
 1597                         		ldx	sPtr
 1598                         		eor	SboxKey+1,X
 1599         [01]            	  .else
 1600  040D   BE 54           		ldx	Text+4+((3+1*1).AND.3)
 1601  040F   D6 07 5C        		lda	p1,X
 1602  0412   B8 75           		eor	SboxKey+1+KBUMP
 1603  0414   97              		tax
 1604  0415   D6 06 5C        		lda	p0,X
 1605  0418   B8 69           		eor	SboxKey+1
 1606         [00]            	  .endif
 1607  041A   97              		tax
 1608         [01]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
 1609  041B   DE 06 5C        		ldx	p0,X		;return result in X
 1610         [01]            	  .else
 1611                         		lda	p0,X		;return result in A
 1612         [00]            	  .endif
 1613         000E            	Sbox8CallCnt	.var Sbox8CallCnt+1
 1614         0011            	Sbox8Size	.var $-tmpS8
 1615         00EE            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
 1616  041E                   		.endm	
 1617         [01]            	  .if USE_MDS_TAB
 1618  041E   BF 8B           		stx	tmp+1
  Tue Jun 16 20:06:03 1998                                                                                               Page   30

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1619         [01]            	  .else
 1620         [02]            	    .if USE_ALPHA_TAB
 1621                         		stx	tmp
 1622                         		txa
 1623                         		eor	t1+3
 1624                         		sta	t1+3
 1625                         		ldx	alpha,X
 1626                         		stx	tmp+1		;tmp+1 = alpha**-1
 1627                         		lda	alpha,X
 1628         [02]            	    .else
 1629                         		sta	tmp		;save the 01 thing
 1630                         		eor	t1+3
 1631                         		sta	t1+3		;xor the 01
 1632                         		lda	tmp
 1633                         		mulAlpha
 1634                         		sta	tmp+1
 1635                         		mulAlpha
 1636         [01]            	    .endif
 1637                         		eor	tmp		;now A = 5B
 1638                         		tax			;save 5B in X
 1639                         		eor	t1+2
 1640                         		sta	t1+2
 1641                         		txa			;A = 5B
 1642                         		eor	tmp+1		;now A = EF
 1643                         		tax			;save 5F in X
 1644                         		eor	t1+1
 1645                         		sta	t1+1
 1646                         		txa	
 1647                         		eor	t1
 1648                         		sta	t1
 1649         [00]            	  .endif
 1650                         		;--- 3rd byte, 3rd MDS column = 5B EF 01 EF
 1651  0420                   		Sbox8	Text+4+((3+1*2).AND.3),p0,p1,p1,SboxKey+2
 1652         0420            	tmpS8		.var $
 1653         [01]            	  .if SboxKey+2.lt.4			;use X as ä ptr?
 1654         [02]            	      .if SboxKey+2.eq.0
 1655                         		stx	sPtr
 1656         [02]            	      .else
 1657                         		ldx	sPtr
 1658         [01]            	      .endif
 1659                         		lda	SboxKey+2+KBUMP,X
 1660                         		ldx	Text+4+((3+1*2).AND.3)
 1661                         		eor	p0,X
 1662                         		tax
 1663                         		lda	p1,X
 1664                         		ldx	sPtr
 1665                         		eor	SboxKey+2,X
 1666         [01]            	  .else
 1667  0420   BE 55           		ldx	Text+4+((3+1*2).AND.3)
 1668  0422   D6 06 5C        		lda	p0,X
 1669  0425   B8 76           		eor	SboxKey+2+KBUMP
 1670  0427   97              		tax
 1671  0428   D6 07 5C        		lda	p1,X
 1672  042B   B8 6A           		eor	SboxKey+2
 1673         [00]            	  .endif
 1674  042D   97              		tax
 1675         [01]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
  Tue Jun 16 20:06:03 1998                                                                                               Page   31

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1676  042E   DE 07 5C        		ldx	p1,X		;return result in X
 1677         [01]            	  .else
 1678                         		lda	p1,X		;return result in A
 1679         [00]            	  .endif
 1680         000F            	Sbox8CallCnt	.var Sbox8CallCnt+1
 1681         0011            	Sbox8Size	.var $-tmpS8
 1682         00FF            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
 1683  0431                   		.endm	
 1684         [01]            	  .if USE_MDS_TAB
 1685  0431   BF 87           		stx	t1+3		;very careful ordering
 1686         [01]            	  .else
 1687         [02]            	    .if USE_ALPHA_TAB
 1688                         		stx	t1+2
 1689                         		txa
 1690                         		eor	t1+2
 1691                         		sta	t1+2
 1692                         		ldx	alpha,X
 1693                         		stx	tmp+1		;tmp+1 = alpha**-1
 1694                         		lda	alpha,X
 1695         [02]            	    .else
 1696                         		sta	tmp		;save the 01 thing
 1697                         		eor	t1+2
 1698                         		sta	t1+2		;xor the 01
 1699                         		lda	tmp
 1700                         		mulAlpha
 1701                         		sta	tmp+1
 1702                         		mulAlpha
 1703         [01]            	    .endif
 1704                         		eor	tmp		;now A = 5B
 1705                         		tax			;save 5B in X
 1706                         		eor	t1
 1707                         		sta	t1
 1708                         		txa			;A = 5B
 1709                         		eor	tmp+1		;now A = EF
 1710                         		tax			;save 5F in X
 1711                         		eor	t1+1
 1712                         		sta	t1+1
 1713                         		txa	
 1714                         		eor	t1+3
 1715                         		sta	t1+3
 1716         [00]            	  .endif
 1717                         		;--- 4th byte, 4th MDS column = 5B 01 EF 5B
 1718  0433                   		Sbox8	Text+4+((3+1*3).AND.3),p1,p1,p0,SboxKey+3
 1719         0433            	tmpS8		.var $
 1720         [01]            	  .if SboxKey+3.lt.4			;use X as ä ptr?
 1721         [02]            	      .if SboxKey+3.eq.0
 1722                         		stx	sPtr
 1723         [02]            	      .else
 1724                         		ldx	sPtr
 1725         [01]            	      .endif
 1726                         		lda	SboxKey+3+KBUMP,X
 1727                         		ldx	Text+4+((3+1*3).AND.3)
 1728                         		eor	p1,X
 1729                         		tax
 1730                         		lda	p1,X
 1731                         		ldx	sPtr
 1732                         		eor	SboxKey+3,X
  Tue Jun 16 20:06:03 1998                                                                                               Page   32

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1733         [01]            	  .else
 1734  0433   BE 56           		ldx	Text+4+((3+1*3).AND.3)
 1735  0435   D6 07 5C        		lda	p1,X
 1736  0438   B8 77           		eor	SboxKey+3+KBUMP
 1737  043A   97              		tax
 1738  043B   D6 07 5C        		lda	p1,X
 1739  043E   B8 6B           		eor	SboxKey+3
 1740         [00]            	  .endif
 1741  0440   97              		tax
 1742         [01]            	  .if USE_ALPHA_TAB.or.USE_MDS_TAB
 1743  0441   DE 06 5C        		ldx	p0,X		;return result in X
 1744         [01]            	  .else
 1745                         		lda	p0,X		;return result in A
 1746         [00]            	  .endif
 1747         0010            	Sbox8CallCnt	.var Sbox8CallCnt+1
 1748         0011            	Sbox8Size	.var $-tmpS8
 1749         0110            	Sbox8ByteCnt	.var Sbox8ByteCnt+Sbox8Size
 1750  0444                   		.endm	
 1751         [01]            	  .if USE_MDS_TAB
 1752  0444   BF 86           		stx	t1+2
 1753         [01]            	  .else
 1754         [02]            	    .if USE_ALPHA_TAB
 1755                         		stx	tmp
 1756                         		txa
 1757                         		eor	t1+1
 1758                         		sta	t1+1
 1759                         		ldx	alpha,X
 1760                         		stx	tmp+1		;tmp+1 = alpha**-1
 1761                         		lda	alpha,X
 1762         [02]            	    .else
 1763                         		sta	tmp		;save the 01 thing
 1764                         		eor	t1+1
 1765                         		sta	t1+1		;xor the 01
 1766                         		lda	tmp
 1767                         		mulAlpha
 1768                         		sta	tmp+1
 1769                         		mulAlpha
 1770         [01]            	    .endif
 1771                         		eor	tmp		;now A = 5B
 1772                         		tax			;save 5B in X
 1773                         		eor	t1
 1774                         		sta	t1
 1775                         		txa			;A = 5B
 1776                         		eor	t1+3
 1777                         		sta	t1+3
 1778                         		txa
 1779                         		eor	tmp+1		;now A = EF
 1780                         		eor	t1+2
 1781                         		sta	t1+2
 1782         [00]            	  .endif
 1783         [01]            	  .if USE_MDS_TAB		;S-box outputs=[tmp,tmp+2,â+3,â+2]
 1784  0446   B6 8A           		lda	tmp		;here with X = 4th S-box output
 1785  0448   D8 08 5C        		eor	tab5B,X
 1786  044B   BE 8B           		ldx	tmp+1
 1787  044D   D8 09 5C        		eor	tabEF,X
 1788  0450   BE 87           		ldx	t1+3
 1789  0452   D8 08 5C        		eor	tab5B,X
  Tue Jun 16 20:06:03 1998                                                                                               Page   33

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1790  0455   B7 84           		sta	t1		;X=3rd S-box output now
 1791                         	
 1792  0457   B6 86           		lda	t1+2
 1793  0459   D8 09 5C        		eor	tabEF,X
 1794  045C   BE 8A           		ldx	tmp
 1795  045E   D8 08 5C        		eor	tab5B,X
 1796  0461   BE 8B           		ldx	tmp+1
 1797  0463   D8 09 5C        		eor	tabEF,X
 1798  0466   B7 85           		sta	t1+1		;X=2nd S-box output now
 1799                         	
 1800  0468   B6 87           		lda	t1+3
 1801  046A   D8 08 5C        		eor	tab5B,X
 1802  046D   BE 8A           		ldx	tmp
 1803  046F   D8 09 5C        		eor	tabEF,X
 1804  0472   BE 86           		ldx	t1+2
 1805  0474   D8 09 5C        		eor	tabEF,X
 1806  0477   B7 86           		sta	t1+2
 1807                         	
 1808  0479   B6 8B           		lda	tmp+1
 1809  047B   D8 08 5C        		eor	tab5B,X
 1810  047E   BE 8A           		ldx	tmp
 1811  0480   D8 09 5C        		eor	tabEF,X
 1812  0483   BE 87           		ldx	t1+3
 1813  0485   D8 09 5C        		eor	tabEF,X
 1814  0488   B7 87           		sta	t1+3
 1815         [00]            	  .endif
 1816         0090            	f32Size		.var $-tmpf32
 1817         0240            	f32ByteCnt	.var f32ByteCnt+f32Size
 1818  048A                   		.endm
 1819  048A                   		add4	t0,t1			;do the PHT thing
 1820  048A                   		op4	add,adc,t0,t1
 1821  048A                   		op1	add,t0  ,t1
 1822         048A            	tmpOp		.var $
 1823  048A   B6 80           		lda	t0
 1824  048C   BB 84           		add	t1
 1825  048E   B7 80           		sta	t0
 1826         0006            	tmpOp		.var $-tmpOp
 1827         0030            	op1ByteCnt .var op1ByteCnt+tmpOp
 1828  0490                   		.endm
 1829  0490                   		op1	adc,t0+1,t1+1
 1830         0490            	tmpOp		.var $
 1831  0490   B6 81           		lda	t0+1
 1832  0492   B9 85           		adc	t1+1
 1833  0494   B7 81           		sta	t0+1
 1834         0006            	tmpOp		.var $-tmpOp
 1835         0036            	op1ByteCnt .var op1ByteCnt+tmpOp
 1836  0496                   		.endm
 1837  0496                   		op1	adc,t0+2,t1+2
 1838         0496            	tmpOp		.var $
 1839  0496   B6 82           		lda	t0+2
 1840  0498   B9 86           		adc	t1+2
 1841  049A   B7 82           		sta	t0+2
 1842         0006            	tmpOp		.var $-tmpOp
 1843         003C            	op1ByteCnt .var op1ByteCnt+tmpOp
 1844  049C                   		.endm
 1845  049C                   		op1	adc,t0+3,t1+3
 1846         049C            	tmpOp		.var $
  Tue Jun 16 20:06:03 1998                                                                                               Page   34

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1847  049C   B6 83           		lda	t0+3
 1848  049E   B9 87           		adc	t1+3
 1849  04A0   B7 83           		sta	t0+3
 1850         0006            	tmpOp		.var $-tmpOp
 1851         0042            	op1ByteCnt .var op1ByteCnt+tmpOp
 1852  04A2                   		.endm
 1853  04A2                   		.endm
 1854  04A2                   		.endm
 1855  04A2                   		add4	t1,t0		
 1856  04A2                   		op4	add,adc,t1,t0
 1857  04A2                   		op1	add,t1  ,t0
 1858         04A2            	tmpOp		.var $
 1859  04A2   B6 84           		lda	t1
 1860  04A4   BB 80           		add	t0
 1861  04A6   B7 84           		sta	t1
 1862         0006            	tmpOp		.var $-tmpOp
 1863         0048            	op1ByteCnt .var op1ByteCnt+tmpOp
 1864  04A8                   		.endm
 1865  04A8                   		op1	adc,t1+1,t0+1
 1866         04A8            	tmpOp		.var $
 1867  04A8   B6 85           		lda	t1+1
 1868  04AA   B9 81           		adc	t0+1
 1869  04AC   B7 85           		sta	t1+1
 1870         0006            	tmpOp		.var $-tmpOp
 1871         004E            	op1ByteCnt .var op1ByteCnt+tmpOp
 1872  04AE                   		.endm
 1873  04AE                   		op1	adc,t1+2,t0+2
 1874         04AE            	tmpOp		.var $
 1875  04AE   B6 86           		lda	t1+2
 1876  04B0   B9 82           		adc	t0+2
 1877  04B2   B7 86           		sta	t1+2
 1878         0006            	tmpOp		.var $-tmpOp
 1879         0054            	op1ByteCnt .var op1ByteCnt+tmpOp
 1880  04B4                   		.endm
 1881  04B4                   		op1	adc,t1+3,t0+3
 1882         04B4            	tmpOp		.var $
 1883  04B4   B6 87           		lda	t1+3
 1884  04B6   B9 83           		adc	t0+3
 1885  04B8   B7 87           		sta	t1+3
 1886         0006            	tmpOp		.var $-tmpOp
 1887         005A            	op1ByteCnt .var op1ByteCnt+tmpOp
 1888  04BA                   		.endm
 1889  04BA                   		.endm
 1890  04BA                   		.endm
 1891                         	
 1892  04BA                   		add4	t0,sk0
 1893  04BA                   		op4	add,adc,t0,sk0
 1894  04BA                   		op1	add,t0  ,sk0
 1895         04BA            	tmpOp		.var $
 1896  04BA   B6 80           		lda	t0
 1897  04BC   BB 78           		add	sk0
 1898  04BE   B7 80           		sta	t0
 1899         0006            	tmpOp		.var $-tmpOp
 1900         0060            	op1ByteCnt .var op1ByteCnt+tmpOp
 1901  04C0                   		.endm
 1902  04C0                   		op1	adc,t0+1,sk0+1
 1903         04C0            	tmpOp		.var $
  Tue Jun 16 20:06:03 1998                                                                                               Page   35

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1904  04C0   B6 81           		lda	t0+1
 1905  04C2   B9 79           		adc	sk0+1
 1906  04C4   B7 81           		sta	t0+1
 1907         0006            	tmpOp		.var $-tmpOp
 1908         0066            	op1ByteCnt .var op1ByteCnt+tmpOp
 1909  04C6                   		.endm
 1910  04C6                   		op1	adc,t0+2,sk0+2
 1911         04C6            	tmpOp		.var $
 1912  04C6   B6 82           		lda	t0+2
 1913  04C8   B9 7A           		adc	sk0+2
 1914  04CA   B7 82           		sta	t0+2
 1915         0006            	tmpOp		.var $-tmpOp
 1916         006C            	op1ByteCnt .var op1ByteCnt+tmpOp
 1917  04CC                   		.endm
 1918  04CC                   		op1	adc,t0+3,sk0+3
 1919         04CC            	tmpOp		.var $
 1920  04CC   B6 83           		lda	t0+3
 1921  04CE   B9 7B           		adc	sk0+3
 1922  04D0   B7 83           		sta	t0+3
 1923         0006            	tmpOp		.var $-tmpOp
 1924         0072            	op1ByteCnt .var op1ByteCnt+tmpOp
 1925  04D2                   		.endm
 1926  04D2                   		.endm
 1927  04D2                   		.endm
 1928  04D2                   		add4	t1,sk1
 1929  04D2                   		op4	add,adc,t1,sk1
 1930  04D2                   		op1	add,t1  ,sk1
 1931         04D2            	tmpOp		.var $
 1932  04D2   B6 84           		lda	t1
 1933  04D4   BB 7C           		add	sk1
 1934  04D6   B7 84           		sta	t1
 1935         0006            	tmpOp		.var $-tmpOp
 1936         0078            	op1ByteCnt .var op1ByteCnt+tmpOp
 1937  04D8                   		.endm
 1938  04D8                   		op1	adc,t1+1,sk1+1
 1939         04D8            	tmpOp		.var $
 1940  04D8   B6 85           		lda	t1+1
 1941  04DA   B9 7D           		adc	sk1+1
 1942  04DC   B7 85           		sta	t1+1
 1943         0006            	tmpOp		.var $-tmpOp
 1944         007E            	op1ByteCnt .var op1ByteCnt+tmpOp
 1945  04DE                   		.endm
 1946  04DE                   		op1	adc,t1+2,sk1+2
 1947         04DE            	tmpOp		.var $
 1948  04DE   B6 86           		lda	t1+2
 1949  04E0   B9 7E           		adc	sk1+2
 1950  04E2   B7 86           		sta	t1+2
 1951         0006            	tmpOp		.var $-tmpOp
 1952         0084            	op1ByteCnt .var op1ByteCnt+tmpOp
 1953  04E4                   		.endm
 1954  04E4                   		op1	adc,t1+3,sk1+3
 1955         04E4            	tmpOp		.var $
 1956  04E4   B6 87           		lda	t1+3
 1957  04E6   B9 7F           		adc	sk1+3
 1958  04E8   B7 87           		sta	t1+3
 1959         0006            	tmpOp		.var $-tmpOp
 1960         008A            	op1ByteCnt .var op1ByteCnt+tmpOp
  Tue Jun 16 20:06:03 1998                                                                                               Page   36

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 1961  04EA                   		.endm
 1962  04EA                   		.endm
 1963  04EA                   		.endm
 1964  04EA   81              		rts
 1965                         	
 1966                         	;----------------------------------------------------------------
 1967                         	; encryptBlock:		Encryption routine
 1968                         	;
 1969                         	;   Input:	Text	=	plaintext block to encrypt
 1970                         	;		Key	=	key to use for encryption
 1971                         	;		SboxKey	=	RS remainder
 1972                         	;   Output:	Text	=	encrypted ciphertext
 1973                         	;----------------------------------------------------------------
 1974                         	;
 1975  04EB                   	encryptBlock:
 1976  04EB   4F              		clra
 1977  04EC   CD 05 4A        		jsr	whiten		
 1978  04EF   A6 08           		lda	#8			;set up for the round subkeys
 1979  04F1   B7 89           		sta	round
 1980  04F3   CD 03 67        		jsr	roundFunc		;skip swap the first time
 1981  04F6   20 03           		bra	eStart			;then enter the loo
 1982  04F8   CD 03 27        	eRound:	jsr	roundSwap
 1983  04FB                   	eStart:	rol4_1	Text+12			;x[3] = ROL(x[3],1)
 1984         04FB            	tmpRot		.var $
 1985  04FB   B6 5C           		lda	Text+12
 1986  04FD   AB 80           		add	#80h		;set carry
 1987  04FF   39 5D           		rol	Text+12+1
 1988  0501   39 5E           		rol	Text+12+2
 1989  0503   39 5F           		rol	Text+12+3
 1990  0505   39 5C           		rol	Text+12
 1991         000C            	tmpRot		.var $-tmpRot
 1992         000C            	rotByteCnt	.var rotByteCnt+tmpRot
 1993  0507                   		.endm
 1994  0507                   		RoundXor
 1995         [01]            	  .if UNROLL_ROUND
 1996  0507                   		xor4	Text+8 ,t0
 1997  0507                   		op4	eor,eor,Text+8,t0
 1998  0507                   		op1	eor,Text+8  ,t0
 1999         0507            	tmpOp		.var $
 2000  0507   B6 58           		lda	Text+8
 2001  0509   B8 80           		eor	t0
 2002  050B   B7 58           		sta	Text+8
 2003         0006            	tmpOp		.var $-tmpOp
 2004         0090            	op1ByteCnt .var op1ByteCnt+tmpOp
 2005  050D                   		.endm
 2006  050D                   		op1	eor,Text+8+1,t0+1
 2007         050D            	tmpOp		.var $
 2008  050D   B6 59           		lda	Text+8+1
 2009  050F   B8 81           		eor	t0+1
 2010  0511   B7 59           		sta	Text+8+1
 2011         0006            	tmpOp		.var $-tmpOp
 2012         0096            	op1ByteCnt .var op1ByteCnt+tmpOp
 2013  0513                   		.endm
 2014  0513                   		op1	eor,Text+8+2,t0+2
 2015         0513            	tmpOp		.var $
 2016  0513   B6 5A           		lda	Text+8+2
 2017  0515   B8 82           		eor	t0+2
  Tue Jun 16 20:06:03 1998                                                                                               Page   37

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2018  0517   B7 5A           		sta	Text+8+2
 2019         0006            	tmpOp		.var $-tmpOp
 2020         009C            	op1ByteCnt .var op1ByteCnt+tmpOp
 2021  0519                   		.endm
 2022  0519                   		op1	eor,Text+8+3,t0+3
 2023         0519            	tmpOp		.var $
 2024  0519   B6 5B           		lda	Text+8+3
 2025  051B   B8 83           		eor	t0+3
 2026  051D   B7 5B           		sta	Text+8+3
 2027         0006            	tmpOp		.var $-tmpOp
 2028         00A2            	op1ByteCnt .var op1ByteCnt+tmpOp
 2029  051F                   		.endm
 2030  051F                   		.endm
 2031  051F                   		.endm
 2032  051F                   		xor4	Text+12,t1
 2033  051F                   		op4	eor,eor,Text+12,t1
 2034  051F                   		op1	eor,Text+12  ,t1
 2035         051F            	tmpOp		.var $
 2036  051F   B6 5C           		lda	Text+12
 2037  0521   B8 84           		eor	t1
 2038  0523   B7 5C           		sta	Text+12
 2039         0006            	tmpOp		.var $-tmpOp
 2040         00A8            	op1ByteCnt .var op1ByteCnt+tmpOp
 2041  0525                   		.endm
 2042  0525                   		op1	eor,Text+12+1,t1+1
 2043         0525            	tmpOp		.var $
 2044  0525   B6 5D           		lda	Text+12+1
 2045  0527   B8 85           		eor	t1+1
 2046  0529   B7 5D           		sta	Text+12+1
 2047         0006            	tmpOp		.var $-tmpOp
 2048         00AE            	op1ByteCnt .var op1ByteCnt+tmpOp
 2049  052B                   		.endm
 2050  052B                   		op1	eor,Text+12+2,t1+2
 2051         052B            	tmpOp		.var $
 2052  052B   B6 5E           		lda	Text+12+2
 2053  052D   B8 86           		eor	t1+2
 2054  052F   B7 5E           		sta	Text+12+2
 2055         0006            	tmpOp		.var $-tmpOp
 2056         00B4            	op1ByteCnt .var op1ByteCnt+tmpOp
 2057  0531                   		.endm
 2058  0531                   		op1	eor,Text+12+3,t1+3
 2059         0531            	tmpOp		.var $
 2060  0531   B6 5F           		lda	Text+12+3
 2061  0533   B8 87           		eor	t1+3
 2062  0535   B7 5F           		sta	Text+12+3
 2063         0006            	tmpOp		.var $-tmpOp
 2064         00BA            	op1ByteCnt .var op1ByteCnt+tmpOp
 2065  0537                   		.endm
 2066  0537                   		.endm
 2067  0537                   		.endm
 2068         [01]            	  .else
 2069                         		jsr	rXor
 2070         [00]            	  .endif
 2071  0537                   	.endm
 2072  0537                   		ror4_1	Text+8			;x[2] = ROR(x[2],1)
 2073         0537            	tmpRot		.var $
 2074  0537   B6 5B           		lda	Text+8+3
  Tue Jun 16 20:06:03 1998                                                                                               Page   38

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2075  0539   44              		lsra			;start the carry bit
 2076  053A   36 5A           		ror	Text+8+2
 2077  053C   36 59           		ror	Text+8+1
 2078  053E   36 58           		ror	Text+8
 2079  0540   36 5B           		ror	Text+8+3
 2080         000B            	tmpRot		.var $-tmpRot
 2081         0017            	rotByteCnt	.var rotByteCnt+tmpRot
 2082  0542                   		.endm
 2083                         	
 2084  0542   B6 89           		lda	round
 2085  0544   A1 28           		cmp	#8+2*ROUNDS
 2086  0546   25 B0           		bcs	eRound
 2087                         	
 2088                         		; here to do final output whitening
 2089  0548   A6 04           	outW:	lda	#4
 2090  054A   B7 89           	whiten:	sta	round
 2091  054C   CD 01 C5        		jsr	computeSubkey
 2092  054F                   		xor4	Text  ,sk0
 2093  054F                   		op4	eor,eor,Text,sk0
 2094  054F                   		op1	eor,Text  ,sk0
 2095         054F            	tmpOp		.var $
 2096  054F   B6 50           		lda	Text
 2097  0551   B8 78           		eor	sk0
 2098  0553   B7 50           		sta	Text
 2099         0006            	tmpOp		.var $-tmpOp
 2100         00C0            	op1ByteCnt .var op1ByteCnt+tmpOp
 2101  0555                   		.endm
 2102  0555                   		op1	eor,Text+1,sk0+1
 2103         0555            	tmpOp		.var $
 2104  0555   B6 51           		lda	Text+1
 2105  0557   B8 79           		eor	sk0+1
 2106  0559   B7 51           		sta	Text+1
 2107         0006            	tmpOp		.var $-tmpOp
 2108         00C6            	op1ByteCnt .var op1ByteCnt+tmpOp
 2109  055B                   		.endm
 2110  055B                   		op1	eor,Text+2,sk0+2
 2111         055B            	tmpOp		.var $
 2112  055B   B6 52           		lda	Text+2
 2113  055D   B8 7A           		eor	sk0+2
 2114  055F   B7 52           		sta	Text+2
 2115         0006            	tmpOp		.var $-tmpOp
 2116         00CC            	op1ByteCnt .var op1ByteCnt+tmpOp
 2117  0561                   		.endm
 2118  0561                   		op1	eor,Text+3,sk0+3
 2119         0561            	tmpOp		.var $
 2120  0561   B6 53           		lda	Text+3
 2121  0563   B8 7B           		eor	sk0+3
 2122  0565   B7 53           		sta	Text+3
 2123         0006            	tmpOp		.var $-tmpOp
 2124         00D2            	op1ByteCnt .var op1ByteCnt+tmpOp
 2125  0567                   		.endm
 2126  0567                   		.endm
 2127  0567                   		.endm
 2128  0567                   		xor4	Text+4,sk1
 2129  0567                   		op4	eor,eor,Text+4,sk1
 2130  0567                   		op1	eor,Text+4  ,sk1
 2131         0567            	tmpOp		.var $
  Tue Jun 16 20:06:03 1998                                                                                               Page   39

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2132  0567   B6 54           		lda	Text+4
 2133  0569   B8 7C           		eor	sk1
 2134  056B   B7 54           		sta	Text+4
 2135         0006            	tmpOp		.var $-tmpOp
 2136         00D8            	op1ByteCnt .var op1ByteCnt+tmpOp
 2137  056D                   		.endm
 2138  056D                   		op1	eor,Text+4+1,sk1+1
 2139         056D            	tmpOp		.var $
 2140  056D   B6 55           		lda	Text+4+1
 2141  056F   B8 7D           		eor	sk1+1
 2142  0571   B7 55           		sta	Text+4+1
 2143         0006            	tmpOp		.var $-tmpOp
 2144         00DE            	op1ByteCnt .var op1ByteCnt+tmpOp
 2145  0573                   		.endm
 2146  0573                   		op1	eor,Text+4+2,sk1+2
 2147         0573            	tmpOp		.var $
 2148  0573   B6 56           		lda	Text+4+2
 2149  0575   B8 7E           		eor	sk1+2
 2150  0577   B7 56           		sta	Text+4+2
 2151         0006            	tmpOp		.var $-tmpOp
 2152         00E4            	op1ByteCnt .var op1ByteCnt+tmpOp
 2153  0579                   		.endm
 2154  0579                   		op1	eor,Text+4+3,sk1+3
 2155         0579            	tmpOp		.var $
 2156  0579   B6 57           		lda	Text+4+3
 2157  057B   B8 7F           		eor	sk1+3
 2158  057D   B7 57           		sta	Text+4+3
 2159         0006            	tmpOp		.var $-tmpOp
 2160         00EA            	op1ByteCnt .var op1ByteCnt+tmpOp
 2161  057F                   		.endm
 2162  057F                   		.endm
 2163  057F                   		.endm
 2164  057F   CD 01 C5        		jsr	computeSubkey
 2165  0582                   		xor4	Text+8,sk0
 2166  0582                   		op4	eor,eor,Text+8,sk0
 2167  0582                   		op1	eor,Text+8  ,sk0
 2168         0582            	tmpOp		.var $
 2169  0582   B6 58           		lda	Text+8
 2170  0584   B8 78           		eor	sk0
 2171  0586   B7 58           		sta	Text+8
 2172         0006            	tmpOp		.var $-tmpOp
 2173         00F0            	op1ByteCnt .var op1ByteCnt+tmpOp
 2174  0588                   		.endm
 2175  0588                   		op1	eor,Text+8+1,sk0+1
 2176         0588            	tmpOp		.var $
 2177  0588   B6 59           		lda	Text+8+1
 2178  058A   B8 79           		eor	sk0+1
 2179  058C   B7 59           		sta	Text+8+1
 2180         0006            	tmpOp		.var $-tmpOp
 2181         00F6            	op1ByteCnt .var op1ByteCnt+tmpOp
 2182  058E                   		.endm
 2183  058E                   		op1	eor,Text+8+2,sk0+2
 2184         058E            	tmpOp		.var $
 2185  058E   B6 5A           		lda	Text+8+2
 2186  0590   B8 7A           		eor	sk0+2
 2187  0592   B7 5A           		sta	Text+8+2
 2188         0006            	tmpOp		.var $-tmpOp
  Tue Jun 16 20:06:03 1998                                                                                               Page   40

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2189         00FC            	op1ByteCnt .var op1ByteCnt+tmpOp
 2190  0594                   		.endm
 2191  0594                   		op1	eor,Text+8+3,sk0+3
 2192         0594            	tmpOp		.var $
 2193  0594   B6 5B           		lda	Text+8+3
 2194  0596   B8 7B           		eor	sk0+3
 2195  0598   B7 5B           		sta	Text+8+3
 2196         0006            	tmpOp		.var $-tmpOp
 2197         0102            	op1ByteCnt .var op1ByteCnt+tmpOp
 2198  059A                   		.endm
 2199  059A                   		.endm
 2200  059A                   		.endm
 2201  059A                   		xor4	Text+12,sk1
 2202  059A                   		op4	eor,eor,Text+12,sk1
 2203  059A                   		op1	eor,Text+12  ,sk1
 2204         059A            	tmpOp		.var $
 2205  059A   B6 5C           		lda	Text+12
 2206  059C   B8 7C           		eor	sk1
 2207  059E   B7 5C           		sta	Text+12
 2208         0006            	tmpOp		.var $-tmpOp
 2209         0108            	op1ByteCnt .var op1ByteCnt+tmpOp
 2210  05A0                   		.endm
 2211  05A0                   		op1	eor,Text+12+1,sk1+1
 2212         05A0            	tmpOp		.var $
 2213  05A0   B6 5D           		lda	Text+12+1
 2214  05A2   B8 7D           		eor	sk1+1
 2215  05A4   B7 5D           		sta	Text+12+1
 2216         0006            	tmpOp		.var $-tmpOp
 2217         010E            	op1ByteCnt .var op1ByteCnt+tmpOp
 2218  05A6                   		.endm
 2219  05A6                   		op1	eor,Text+12+2,sk1+2
 2220         05A6            	tmpOp		.var $
 2221  05A6   B6 5E           		lda	Text+12+2
 2222  05A8   B8 7E           		eor	sk1+2
 2223  05AA   B7 5E           		sta	Text+12+2
 2224         0006            	tmpOp		.var $-tmpOp
 2225         0114            	op1ByteCnt .var op1ByteCnt+tmpOp
 2226  05AC                   		.endm
 2227  05AC                   		op1	eor,Text+12+3,sk1+3
 2228         05AC            	tmpOp		.var $
 2229  05AC   B6 5F           		lda	Text+12+3
 2230  05AE   B8 7F           		eor	sk1+3
 2231  05B0   B7 5F           		sta	Text+12+3
 2232         0006            	tmpOp		.var $-tmpOp
 2233         011A            	op1ByteCnt .var op1ByteCnt+tmpOp
 2234  05B2                   		.endm
 2235  05B2                   		.endm
 2236  05B2                   		.endm
 2237  05B2   81              		rts
 2238                         	;
 2239                         	;----------------------------------------------------------------
 2240                         	; decryptBlock:		Decryption routine
 2241                         	;
 2242                         	;   Input:	Text	=	ciphertext block to decrypt
 2243                         	;		Key	=	key to use for decryption
 2244                         	;		SboxKey	=	RS remainder
 2245                         	;   Output:	Text	=	decrypted plaintext
  Tue Jun 16 20:06:03 1998                                                                                               Page   41

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2246                         	;----------------------------------------------------------------
 2247                         	;
 2248  05B3                   	decryptBlock:
 2249  05B3   AD 93           		bsr	outW			;undo output whitening
 2250  05B5   A6 26           		lda	#8+2*ROUNDS-2		;set up for the round subkeys
 2251  05B7   B7 89           		sta	round
 2252  05B9   CD 03 67        		jsr	roundFunc		;skip swap the first time
 2253  05BC   20 03           		bra	dStart			;then enter the loop
 2254  05BE   CD 03 27        	dRound:	jsr	roundSwap
 2255  05C1                   	dStart:	rol4_1	Text+8			;x[2]=ROL(x[2],1)
 2256         05C1            	tmpRot		.var $
 2257  05C1   B6 58           		lda	Text+8
 2258  05C3   AB 80           		add	#80h		;set carry
 2259  05C5   39 59           		rol	Text+8+1
 2260  05C7   39 5A           		rol	Text+8+2
 2261  05C9   39 5B           		rol	Text+8+3
 2262  05CB   39 58           		rol	Text+8
 2263         000C            	tmpRot		.var $-tmpRot
 2264         0023            	rotByteCnt	.var rotByteCnt+tmpRot
 2265  05CD                   		.endm
 2266  05CD                   		RoundXor
 2267         [01]            	  .if UNROLL_ROUND
 2268  05CD                   		xor4	Text+8 ,t0
 2269  05CD                   		op4	eor,eor,Text+8,t0
 2270  05CD                   		op1	eor,Text+8  ,t0
 2271         05CD            	tmpOp		.var $
 2272  05CD   B6 58           		lda	Text+8
 2273  05CF   B8 80           		eor	t0
 2274  05D1   B7 58           		sta	Text+8
 2275         0006            	tmpOp		.var $-tmpOp
 2276         0120            	op1ByteCnt .var op1ByteCnt+tmpOp
 2277  05D3                   		.endm
 2278  05D3                   		op1	eor,Text+8+1,t0+1
 2279         05D3            	tmpOp		.var $
 2280  05D3   B6 59           		lda	Text+8+1
 2281  05D5   B8 81           		eor	t0+1
 2282  05D7   B7 59           		sta	Text+8+1
 2283         0006            	tmpOp		.var $-tmpOp
 2284         0126            	op1ByteCnt .var op1ByteCnt+tmpOp
 2285  05D9                   		.endm
 2286  05D9                   		op1	eor,Text+8+2,t0+2
 2287         05D9            	tmpOp		.var $
 2288  05D9   B6 5A           		lda	Text+8+2
 2289  05DB   B8 82           		eor	t0+2
 2290  05DD   B7 5A           		sta	Text+8+2
 2291         0006            	tmpOp		.var $-tmpOp
 2292         012C            	op1ByteCnt .var op1ByteCnt+tmpOp
 2293  05DF                   		.endm
 2294  05DF                   		op1	eor,Text+8+3,t0+3
 2295         05DF            	tmpOp		.var $
 2296  05DF   B6 5B           		lda	Text+8+3
 2297  05E1   B8 83           		eor	t0+3
 2298  05E3   B7 5B           		sta	Text+8+3
 2299         0006            	tmpOp		.var $-tmpOp
 2300         0132            	op1ByteCnt .var op1ByteCnt+tmpOp
 2301  05E5                   		.endm
 2302  05E5                   		.endm
  Tue Jun 16 20:06:03 1998                                                                                               Page   42

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2303  05E5                   		.endm
 2304  05E5                   		xor4	Text+12,t1
 2305  05E5                   		op4	eor,eor,Text+12,t1
 2306  05E5                   		op1	eor,Text+12  ,t1
 2307         05E5            	tmpOp		.var $
 2308  05E5   B6 5C           		lda	Text+12
 2309  05E7   B8 84           		eor	t1
 2310  05E9   B7 5C           		sta	Text+12
 2311         0006            	tmpOp		.var $-tmpOp
 2312         0138            	op1ByteCnt .var op1ByteCnt+tmpOp
 2313  05EB                   		.endm
 2314  05EB                   		op1	eor,Text+12+1,t1+1
 2315         05EB            	tmpOp		.var $
 2316  05EB   B6 5D           		lda	Text+12+1
 2317  05ED   B8 85           		eor	t1+1
 2318  05EF   B7 5D           		sta	Text+12+1
 2319         0006            	tmpOp		.var $-tmpOp
 2320         013E            	op1ByteCnt .var op1ByteCnt+tmpOp
 2321  05F1                   		.endm
 2322  05F1                   		op1	eor,Text+12+2,t1+2
 2323         05F1            	tmpOp		.var $
 2324  05F1   B6 5E           		lda	Text+12+2
 2325  05F3   B8 86           		eor	t1+2
 2326  05F5   B7 5E           		sta	Text+12+2
 2327         0006            	tmpOp		.var $-tmpOp
 2328         0144            	op1ByteCnt .var op1ByteCnt+tmpOp
 2329  05F7                   		.endm
 2330  05F7                   		op1	eor,Text+12+3,t1+3
 2331         05F7            	tmpOp		.var $
 2332  05F7   B6 5F           		lda	Text+12+3
 2333  05F9   B8 87           		eor	t1+3
 2334  05FB   B7 5F           		sta	Text+12+3
 2335         0006            	tmpOp		.var $-tmpOp
 2336         014A            	op1ByteCnt .var op1ByteCnt+tmpOp
 2337  05FD                   		.endm
 2338  05FD                   		.endm
 2339  05FD                   		.endm
 2340         [01]            	  .else
 2341                         		jsr	rXor
 2342         [00]            	  .endif
 2343  05FD                   	.endm
 2344  05FD                   		ror4_1	Text+12			;x[3]=ROR(x[3],1)
 2345         05FD            	tmpRot		.var $
 2346  05FD   B6 5F           		lda	Text+12+3
 2347  05FF   44              		lsra			;start the carry bit
 2348  0600   36 5E           		ror	Text+12+2
 2349  0602   36 5D           		ror	Text+12+1
 2350  0604   36 5C           		ror	Text+12
 2351  0606   36 5F           		ror	Text+12+3
 2352         000B            	tmpRot		.var $-tmpRot
 2353         002E            	rotByteCnt	.var rotByteCnt+tmpRot
 2354  0608                   		.endm
 2355  0608   B6 89           		lda	round
 2356  060A   A0 04           		sub	#4			;back up (undo double increment)
 2357  060C   B7 89           		sta	round
 2358  060E   A1 08           		cmp	#8
 2359  0610   24 AC           		bcc	dRound
  Tue Jun 16 20:06:03 1998                                                                                               Page   43

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2360                         		; here to undo input whitening as final decryption step
 2361  0612   4F              		clra
 2362  0613   CC 05 4A        		jmp	whiten	
 2363                         	;
 2364                         	;
 2365                         	;----------------------------------------------------------------
 2366                         	; RSremainder:		Compute remainder
 2367                         	;
 2368                         	;   Input:	X	=	ptr to 8 bytes of key 
 2369                         	;   Output:	remainder computed
 2370                         	;----------------------------------------------------------------
 2371                         	; Reed-Solomon code parameters: (12,8) reversible code
 2372                         	;	g(x) = x**4 + (a + 1/a) x**3 + a x**2 + (a + 1/a) x + 1
 2373                         	;   where a = primitive root of field generator 0x14D
 2374                         	;
 2375         014D            	RS_FDBK	.var	14Dh
 2376  0616                   	RSremainder:
 2377  0616   BF 78           		stx	sk0		;use sk0 as temp location
 2378  0618   6F 08           		clr	8,X	
 2379  061A   6F 09           		clr	9,X	
 2380  061C   6F 0A           		clr	10,X	
 2381  061E   6F 0B           		clr	11,X	
 2382  0620   A6 08           		lda	#8
 2383  0622   B7 79           		sta	sk0+1		;use this as a counter
 2384  0624   E6 07           	RSloop:	lda	7,X
 2385  0626   5A              		decx
 2386  0627   BF 7A           		stx	sk0+2		;store ptr to next data byte
 2387  0629   BE 78           		ldx	sk0		;get back remainder ptr
 2388  062B   E8 0B           		eor	11,X
 2389                         	; new code
 2390  062D   B7 7B           		sta	sk0+3
 2391  062F   48              		asla			;multiply by alpha
 2392  0630   24 02           		bcc	noXor1	
 2393  0632   A8 4D           		eor	#(RS_FDBK.AND.0FFH)
 2394  0634   B7 7C           	noXor1:	sta	sk0+4		;save alpha term
 2395  0636   B6 7B           		lda	sk0+3
 2396  0638   44              		lsra
 2397  0639   24 02           		bcc	noXor2
 2398  063B   A8 A6           		eor	#(RS_FDBK.SHR.1)
 2399  063D   B8 7C           	noXor2:	eor	sk0+4		;this is the alpha + 1/alpha term
 2400  063F   B7 7D           		sta	sk0+5
 2401  0641   E8 0A           		eor	10,X		;feedback and shift all at once
 2402  0643   E7 0B           		sta	11,X
 2403  0645   B6 7C           		lda	sk0+4
 2404  0647   E8 09           		eor	9,X
 2405  0649   E7 0A           		sta	10,X
 2406  064B   B6 7D           		lda	sk0+5
 2407  064D   E8 08           		eor	8,X
 2408  064F   E7 09           		sta	9,X
 2409  0651   B6 7B           		lda	sk0+3
 2410  0653   E7 08           		sta	8,X
 2411                         	; end of new code
 2412  0655   BE 7A           		ldx	sk0+2		;get back the pointer
 2413  0657   3A 79           		dec	sk0+1
 2414  0659   26 C9           		bne	RSloop
 2415  065B   81              		rts
 2416                         	
  Tue Jun 16 20:06:03 1998                                                                                               Page   44

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2417                         	;----------------------------------------------------------------
 2418                         	;	Twofish lookup tables
 2419         065C            	tableStart	.var	$
 2420  065B                   		include	table.inc
 2421  065C   A9 67 B3 E8 04  	p0:	.byte 0A9h, 067h, 0B3h, 0E8h, 004h, 0FDh, 0A3h, 076h
               FD A3 76 
 2422  0664   9A 92 80 78 E4  		.byte 09Ah, 092h, 080h, 078h, 0E4h, 0DDh, 0D1h, 038h
               DD D1 38 
 2423  066C   0D C6 35 98 18  		.byte 00Dh, 0C6h, 035h, 098h, 018h, 0F7h, 0ECh, 06Ch
               F7 EC 6C 
 2424  0674   43 75 37 26 FA  		.byte 043h, 075h, 037h, 026h, 0FAh, 013h, 094h, 048h
               13 94 48 
 2425  067C   F2 D0 8B 30 84  		.byte 0F2h, 0D0h, 08Bh, 030h, 084h, 054h, 0DFh, 023h
               54 DF 23 
 2426  0684   19 5B 3D 59 F3  		.byte 019h, 05Bh, 03Dh, 059h, 0F3h, 0AEh, 0A2h, 082h
               AE A2 82 
 2427  068C   63 01 83 2E D9  		.byte 063h, 001h, 083h, 02Eh, 0D9h, 051h, 09Bh, 07Ch
               51 9B 7C 
 2428  0694   A6 EB A5 BE 16  		.byte 0A6h, 0EBh, 0A5h, 0BEh, 016h, 00Ch, 0E3h, 061h
               0C E3 61 
 2429  069C   C0 8C 3A F5 73  		.byte 0C0h, 08Ch, 03Ah, 0F5h, 073h, 02Ch, 025h, 00Bh
               2C 25 0B 
 2430  06A4   BB 4E 89 6B 53  		.byte 0BBh, 04Eh, 089h, 06Bh, 053h, 06Ah, 0B4h, 0F1h
               6A B4 F1 
 2431  06AC   E1 E6 BD 45 E2  		.byte 0E1h, 0E6h, 0BDh, 045h, 0E2h, 0F4h, 0B6h, 066h
               F4 B6 66 
 2432  06B4   CC 95 03 56 D4  		.byte 0CCh, 095h, 003h, 056h, 0D4h, 01Ch, 01Eh, 0D7h
               1C 1E D7 
 2433  06BC   FB C3 8E B5 E9  		.byte 0FBh, 0C3h, 08Eh, 0B5h, 0E9h, 0CFh, 0BFh, 0BAh
               CF BF BA 
 2434  06C4   EA 77 39 AF 33  		.byte 0EAh, 077h, 039h, 0AFh, 033h, 0C9h, 062h, 071h
               C9 62 71 
 2435  06CC   81 79 09 AD 24  		.byte 081h, 079h, 009h, 0ADh, 024h, 0CDh, 0F9h, 0D8h
               CD F9 D8 
 2436  06D4   E5 C5 B9 4D 44  		.byte 0E5h, 0C5h, 0B9h, 04Dh, 044h, 008h, 086h, 0E7h
               08 86 E7 
 2437  06DC   A1 1D AA ED 06  		.byte 0A1h, 01Dh, 0AAh, 0EDh, 006h, 070h, 0B2h, 0D2h
               70 B2 D2 
 2438  06E4   41 7B A0 11 31  		.byte 041h, 07Bh, 0A0h, 011h, 031h, 0C2h, 027h, 090h
               C2 27 90 
 2439  06EC   20 F6 60 FF 96  		.byte 020h, 0F6h, 060h, 0FFh, 096h, 05Ch, 0B1h, 0ABh
               5C B1 AB 
 2440  06F4   9E 9C 52 1B 5F  		.byte 09Eh, 09Ch, 052h, 01Bh, 05Fh, 093h, 00Ah, 0EFh
               93 0A EF 
 2441  06FC   91 85 49 EE 2D  		.byte 091h, 085h, 049h, 0EEh, 02Dh, 04Fh, 08Fh, 03Bh
               4F 8F 3B 
 2442  0704   47 87 6D 46 D6  		.byte 047h, 087h, 06Dh, 046h, 0D6h, 03Eh, 069h, 064h
               3E 69 64 
 2443  070C   2A CE CB 2F FC  		.byte 02Ah, 0CEh, 0CBh, 02Fh, 0FCh, 097h, 005h, 07Ah
               97 05 7A 
 2444  0714   AC 7F D5 1A 4B  		.byte 0ACh, 07Fh, 0D5h, 01Ah, 04Bh, 00Eh, 0A7h, 05Ah
               0E A7 5A 
 2445  071C   28 14 3F 29 88  		.byte 028h, 014h, 03Fh, 029h, 088h, 03Ch, 04Ch, 002h
               3C 4C 02 
 2446  0724   B8 DA B0 17 55  		.byte 0B8h, 0DAh, 0B0h, 017h, 055h, 01Fh, 08Ah, 07Dh
               1F 8A 7D 
 2447  072C   57 C7 8D 74 B7  		.byte 057h, 0C7h, 08Dh, 074h, 0B7h, 0C4h, 09Fh, 072h
  Tue Jun 16 20:06:03 1998                                                                                               Page   45

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

               C4 9F 72 
 2448  0734   7E 15 22 12 58  		.byte 07Eh, 015h, 022h, 012h, 058h, 007h, 099h, 034h
               07 99 34 
 2449  073C   6E 50 DE 68 65  		.byte 06Eh, 050h, 0DEh, 068h, 065h, 0BCh, 0DBh, 0F8h
               BC DB F8 
 2450  0744   C8 A8 2B 40 DC  		.byte 0C8h, 0A8h, 02Bh, 040h, 0DCh, 0FEh, 032h, 0A4h
               FE 32 A4 
 2451  074C   CA 10 21 F0 D3  		.byte 0CAh, 010h, 021h, 0F0h, 0D3h, 05Dh, 00Fh, 000h
               5D 0F 00 
 2452  0754   6F 9D 36 42 4A  		.byte 06Fh, 09Dh, 036h, 042h, 04Ah, 05Eh, 0C1h, 0E0h
               5E C1 E0 
 2453                         	
 2454  075C   75 F3 C6 F4 DB  	p1:	.byte 075h, 0F3h, 0C6h, 0F4h, 0DBh, 07Bh, 0FBh, 0C8h
               7B FB C8 
 2455  0764   4A D3 E6 6B 45  		.byte 04Ah, 0D3h, 0E6h, 06Bh, 045h, 07Dh, 0E8h, 04Bh
               7D E8 4B 
 2456  076C   D6 32 D8 FD 37  		.byte 0D6h, 032h, 0D8h, 0FDh, 037h, 071h, 0F1h, 0E1h
               71 F1 E1 
 2457  0774   30 0F F8 1B 87  		.byte 030h, 00Fh, 0F8h, 01Bh, 087h, 0FAh, 006h, 03Fh
               FA 06 3F 
 2458  077C   5E BA AE 5B 8A  		.byte 05Eh, 0BAh, 0AEh, 05Bh, 08Ah, 000h, 0BCh, 09Dh
               00 BC 9D 
 2459  0784   6D C1 B1 0E 80  		.byte 06Dh, 0C1h, 0B1h, 00Eh, 080h, 05Dh, 0D2h, 0D5h
               5D D2 D5 
 2460  078C   A0 84 07 14 B5  		.byte 0A0h, 084h, 007h, 014h, 0B5h, 090h, 02Ch, 0A3h
               90 2C A3 
 2461  0794   B2 73 4C 54 92  		.byte 0B2h, 073h, 04Ch, 054h, 092h, 074h, 036h, 051h
               74 36 51 
 2462  079C   38 B0 BD 5A FC  		.byte 038h, 0B0h, 0BDh, 05Ah, 0FCh, 060h, 062h, 096h
               60 62 96 
 2463  07A4   6C 42 F7 10 7C  		.byte 06Ch, 042h, 0F7h, 010h, 07Ch, 028h, 027h, 08Ch
               28 27 8C 
 2464  07AC   13 95 9C C7 24  		.byte 013h, 095h, 09Ch, 0C7h, 024h, 046h, 03Bh, 070h
               46 3B 70 
 2465  07B4   CA E3 85 CB 11  		.byte 0CAh, 0E3h, 085h, 0CBh, 011h, 0D0h, 093h, 0B8h
               D0 93 B8 
 2466  07BC   A6 83 20 FF 9F  		.byte 0A6h, 083h, 020h, 0FFh, 09Fh, 077h, 0C3h, 0CCh
               77 C3 CC 
 2467  07C4   03 6F 08 BF 40  		.byte 003h, 06Fh, 008h, 0BFh, 040h, 0E7h, 02Bh, 0E2h
               E7 2B E2 
 2468  07CC   79 0C AA 82 41  		.byte 079h, 00Ch, 0AAh, 082h, 041h, 03Ah, 0EAh, 0B9h
               3A EA B9 
 2469  07D4   E4 9A A4 97 7E  		.byte 0E4h, 09Ah, 0A4h, 097h, 07Eh, 0DAh, 07Ah, 017h
               DA 7A 17 
 2470  07DC   66 94 A1 1D 3D  		.byte 066h, 094h, 0A1h, 01Dh, 03Dh, 0F0h, 0DEh, 0B3h
               F0 DE B3 
 2471  07E4   0B 72 A7 1C EF  		.byte 00Bh, 072h, 0A7h, 01Ch, 0EFh, 0D1h, 053h, 03Eh
               D1 53 3E 
 2472  07EC   8F 33 26 5F EC  		.byte 08Fh, 033h, 026h, 05Fh, 0ECh, 076h, 02Ah, 049h
               76 2A 49 
 2473  07F4   81 88 EE 21 C4  		.byte 081h, 088h, 0EEh, 021h, 0C4h, 01Ah, 0EBh, 0D9h
               1A EB D9 
 2474  07FC   C5 39 99 CD AD  		.byte 0C5h, 039h, 099h, 0CDh, 0ADh, 031h, 08Bh, 001h
               31 8B 01 
 2475  0804   18 23 DD 1F 4E  		.byte 018h, 023h, 0DDh, 01Fh, 04Eh, 02Dh, 0F9h, 048h
               2D F9 48 
 2476  080C   4F F2 65 8E 78  		.byte 04Fh, 0F2h, 065h, 08Eh, 078h, 05Ch, 058h, 019h
  Tue Jun 16 20:06:03 1998                                                                                               Page   46

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

               5C 58 19 
 2477  0814   8D E5 98 57 67  		.byte 08Dh, 0E5h, 098h, 057h, 067h, 07Fh, 005h, 064h
               7F 05 64 
 2478  081C   AF 63 B6 FE F5  		.byte 0AFh, 063h, 0B6h, 0FEh, 0F5h, 0B7h, 03Ch, 0A5h
               B7 3C A5 
 2479  0824   CE E9 68 44 E0  		.byte 0CEh, 0E9h, 068h, 044h, 0E0h, 04Dh, 043h, 069h
               4D 43 69 
 2480  082C   29 2E AC 15 59  		.byte 029h, 02Eh, 0ACh, 015h, 059h, 0A8h, 00Ah, 09Eh
               A8 0A 9E 
 2481  0834   6E 47 DF 34 35  		.byte 06Eh, 047h, 0DFh, 034h, 035h, 06Ah, 0CFh, 0DCh
               6A CF DC 
 2482  083C   22 C9 C0 9B 89  		.byte 022h, 0C9h, 0C0h, 09Bh, 089h, 0D4h, 0EDh, 0ABh
               D4 ED AB 
 2483  0844   12 A2 0D 52 BB  		.byte 012h, 0A2h, 00Dh, 052h, 0BBh, 002h, 02Fh, 0A9h
               02 2F A9 
 2484  084C   D7 61 1E B4 50  		.byte 0D7h, 061h, 01Eh, 0B4h, 050h, 004h, 0F6h, 0C2h
               04 F6 C2 
 2485  0854   16 25 86 56 55  		.byte 016h, 025h, 086h, 056h, 055h, 009h, 0BEh, 091h
               09 BE 91 
 2486                         	;
 2487         [01]            	  .if USE_ALPHA_TAB.and.(.not.USE_MDS_TAB)
 2488                         	alpha:  ; multiply by alpha**-1, g(x) = 169
 2489                         		.byte 000h, 0B4h, 001h, 0B5h, 002h, 0B6h, 003h, 0B7h
 2490                         		.byte 004h, 0B0h, 005h, 0B1h, 006h, 0B2h, 007h, 0B3h
 2491                         		.byte 008h, 0BCh, 009h, 0BDh, 00Ah, 0BEh, 00Bh, 0BFh
 2492                         		.byte 00Ch, 0B8h, 00Dh, 0B9h, 00Eh, 0BAh, 00Fh, 0BBh
 2493                         		.byte 010h, 0A4h, 011h, 0A5h, 012h, 0A6h, 013h, 0A7h
 2494                         		.byte 014h, 0A0h, 015h, 0A1h, 016h, 0A2h, 017h, 0A3h
 2495                         		.byte 018h, 0ACh, 019h, 0ADh, 01Ah, 0AEh, 01Bh, 0AFh
 2496                         		.byte 01Ch, 0A8h, 01Dh, 0A9h, 01Eh, 0AAh, 01Fh, 0ABh
 2497                         		.byte 020h, 094h, 021h, 095h, 022h, 096h, 023h, 097h
 2498                         		.byte 024h, 090h, 025h, 091h, 026h, 092h, 027h, 093h
 2499                         		.byte 028h, 09Ch, 029h, 09Dh, 02Ah, 09Eh, 02Bh, 09Fh
 2500                         		.byte 02Ch, 098h, 02Dh, 099h, 02Eh, 09Ah, 02Fh, 09Bh
 2501                         		.byte 030h, 084h, 031h, 085h, 032h, 086h, 033h, 087h
 2502                         		.byte 034h, 080h, 035h, 081h, 036h, 082h, 037h, 083h
 2503                         		.byte 038h, 08Ch, 039h, 08Dh, 03Ah, 08Eh, 03Bh, 08Fh
 2504                         		.byte 03Ch, 088h, 03Dh, 089h, 03Eh, 08Ah, 03Fh, 08Bh
 2505                         		.byte 040h, 0F4h, 041h, 0F5h, 042h, 0F6h, 043h, 0F7h
 2506                         		.byte 044h, 0F0h, 045h, 0F1h, 046h, 0F2h, 047h, 0F3h
 2507                         		.byte 048h, 0FCh, 049h, 0FDh, 04Ah, 0FEh, 04Bh, 0FFh
 2508                         		.byte 04Ch, 0F8h, 04Dh, 0F9h, 04Eh, 0FAh, 04Fh, 0FBh
 2509                         		.byte 050h, 0E4h, 051h, 0E5h, 052h, 0E6h, 053h, 0E7h
 2510                         		.byte 054h, 0E0h, 055h, 0E1h, 056h, 0E2h, 057h, 0E3h
 2511                         		.byte 058h, 0ECh, 059h, 0EDh, 05Ah, 0EEh, 05Bh, 0EFh
 2512                         		.byte 05Ch, 0E8h, 05Dh, 0E9h, 05Eh, 0EAh, 05Fh, 0EBh
 2513                         		.byte 060h, 0D4h, 061h, 0D5h, 062h, 0D6h, 063h, 0D7h
 2514                         		.byte 064h, 0D0h, 065h, 0D1h, 066h, 0D2h, 067h, 0D3h
 2515                         		.byte 068h, 0DCh, 069h, 0DDh, 06Ah, 0DEh, 06Bh, 0DFh
 2516                         		.byte 06Ch, 0D8h, 06Dh, 0D9h, 06Eh, 0DAh, 06Fh, 0DBh
 2517                         		.byte 070h, 0C4h, 071h, 0C5h, 072h, 0C6h, 073h, 0C7h
 2518                         		.byte 074h, 0C0h, 075h, 0C1h, 076h, 0C2h, 077h, 0C3h
 2519                         		.byte 078h, 0CCh, 079h, 0CDh, 07Ah, 0CEh, 07Bh, 0CFh
 2520                         		.byte 07Ch, 0C8h, 07Dh, 0C9h, 07Eh, 0CAh, 07Fh, 0CBh
 2521         [00]            	  .endif
 2522         [01]            	.if USE_MDS_TAB
 2523                         	;
  Tue Jun 16 20:06:03 1998                                                                                               Page   47

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2524                         	tab5B: ; multiply by 5B (alpha**-2 + 1)
 2525  085C   00 5B B6 ED 05  		.byte 000h, 05Bh, 0B6h, 0EDh, 005h, 05Eh, 0B3h, 0E8h
               5E B3 E8 
 2526  0864   0A 51 BC E7 0F  		.byte 00Ah, 051h, 0BCh, 0E7h, 00Fh, 054h, 0B9h, 0E2h
               54 B9 E2 
 2527  086C   14 4F A2 F9 11  		.byte 014h, 04Fh, 0A2h, 0F9h, 011h, 04Ah, 0A7h, 0FCh
               4A A7 FC 
 2528  0874   1E 45 A8 F3 1B  		.byte 01Eh, 045h, 0A8h, 0F3h, 01Bh, 040h, 0ADh, 0F6h
               40 AD F6 
 2529  087C   28 73 9E C5 2D  		.byte 028h, 073h, 09Eh, 0C5h, 02Dh, 076h, 09Bh, 0C0h
               76 9B C0 
 2530  0884   22 79 94 CF 27  		.byte 022h, 079h, 094h, 0CFh, 027h, 07Ch, 091h, 0CAh
               7C 91 CA 
 2531  088C   3C 67 8A D1 39  		.byte 03Ch, 067h, 08Ah, 0D1h, 039h, 062h, 08Fh, 0D4h
               62 8F D4 
 2532  0894   36 6D 80 DB 33  		.byte 036h, 06Dh, 080h, 0DBh, 033h, 068h, 085h, 0DEh
               68 85 DE 
 2533  089C   50 0B E6 BD 55  		.byte 050h, 00Bh, 0E6h, 0BDh, 055h, 00Eh, 0E3h, 0B8h
               0E E3 B8 
 2534  08A4   5A 01 EC B7 5F  		.byte 05Ah, 001h, 0ECh, 0B7h, 05Fh, 004h, 0E9h, 0B2h
               04 E9 B2 
 2535  08AC   44 1F F2 A9 41  		.byte 044h, 01Fh, 0F2h, 0A9h, 041h, 01Ah, 0F7h, 0ACh
               1A F7 AC 
 2536  08B4   4E 15 F8 A3 4B  		.byte 04Eh, 015h, 0F8h, 0A3h, 04Bh, 010h, 0FDh, 0A6h
               10 FD A6 
 2537  08BC   78 23 CE 95 7D  		.byte 078h, 023h, 0CEh, 095h, 07Dh, 026h, 0CBh, 090h
               26 CB 90 
 2538  08C4   72 29 C4 9F 77  		.byte 072h, 029h, 0C4h, 09Fh, 077h, 02Ch, 0C1h, 09Ah
               2C C1 9A 
 2539  08CC   6C 37 DA 81 69  		.byte 06Ch, 037h, 0DAh, 081h, 069h, 032h, 0DFh, 084h
               32 DF 84 
 2540  08D4   66 3D D0 8B 63  		.byte 066h, 03Dh, 0D0h, 08Bh, 063h, 038h, 0D5h, 08Eh
               38 D5 8E 
 2541  08DC   A0 FB 16 4D A5  		.byte 0A0h, 0FBh, 016h, 04Dh, 0A5h, 0FEh, 013h, 048h
               FE 13 48 
 2542  08E4   AA F1 1C 47 AF  		.byte 0AAh, 0F1h, 01Ch, 047h, 0AFh, 0F4h, 019h, 042h
               F4 19 42 
 2543  08EC   B4 EF 02 59 B1  		.byte 0B4h, 0EFh, 002h, 059h, 0B1h, 0EAh, 007h, 05Ch
               EA 07 5C 
 2544  08F4   BE E5 08 53 BB  		.byte 0BEh, 0E5h, 008h, 053h, 0BBh, 0E0h, 00Dh, 056h
               E0 0D 56 
 2545  08FC   88 D3 3E 65 8D  		.byte 088h, 0D3h, 03Eh, 065h, 08Dh, 0D6h, 03Bh, 060h
               D6 3B 60 
 2546  0904   82 D9 34 6F 87  		.byte 082h, 0D9h, 034h, 06Fh, 087h, 0DCh, 031h, 06Ah
               DC 31 6A 
 2547  090C   9C C7 2A 71 99  		.byte 09Ch, 0C7h, 02Ah, 071h, 099h, 0C2h, 02Fh, 074h
               C2 2F 74 
 2548  0914   96 CD 20 7B 93  		.byte 096h, 0CDh, 020h, 07Bh, 093h, 0C8h, 025h, 07Eh
               C8 25 7E 
 2549  091C   F0 AB 46 1D F5  		.byte 0F0h, 0ABh, 046h, 01Dh, 0F5h, 0AEh, 043h, 018h
               AE 43 18 
 2550  0924   FA A1 4C 17 FF  		.byte 0FAh, 0A1h, 04Ch, 017h, 0FFh, 0A4h, 049h, 012h
               A4 49 12 
 2551  092C   E4 BF 52 09 E1  		.byte 0E4h, 0BFh, 052h, 009h, 0E1h, 0BAh, 057h, 00Ch
               BA 57 0C 
 2552  0934   EE B5 58 03 EB  		.byte 0EEh, 0B5h, 058h, 003h, 0EBh, 0B0h, 05Dh, 006h
               B0 5D 06 
  Tue Jun 16 20:06:03 1998                                                                                               Page   48

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2553  093C   D8 83 6E 35 DD  		.byte 0D8h, 083h, 06Eh, 035h, 0DDh, 086h, 06Bh, 030h
               86 6B 30 
 2554  0944   D2 89 64 3F D7  		.byte 0D2h, 089h, 064h, 03Fh, 0D7h, 08Ch, 061h, 03Ah
               8C 61 3A 
 2555  094C   CC 97 7A 21 C9  		.byte 0CCh, 097h, 07Ah, 021h, 0C9h, 092h, 07Fh, 024h
               92 7F 24 
 2556  0954   C6 9D 70 2B C3  		.byte 0C6h, 09Dh, 070h, 02Bh, 0C3h, 098h, 075h, 02Eh
               98 75 2E 
 2557                         	;
 2558                         	tabEF: ; multiply by EF (alpha**-2 + alpha**-1 + 1)
 2559  095C   00 EF B7 58 07  		.byte 000h, 0EFh, 0B7h, 058h, 007h, 0E8h, 0B0h, 05Fh
               E8 B0 5F 
 2560  0964   0E E1 B9 56 09  		.byte 00Eh, 0E1h, 0B9h, 056h, 009h, 0E6h, 0BEh, 051h
               E6 BE 51 
 2561  096C   1C F3 AB 44 1B  		.byte 01Ch, 0F3h, 0ABh, 044h, 01Bh, 0F4h, 0ACh, 043h
               F4 AC 43 
 2562  0974   12 FD A5 4A 15  		.byte 012h, 0FDh, 0A5h, 04Ah, 015h, 0FAh, 0A2h, 04Dh
               FA A2 4D 
 2563  097C   38 D7 8F 60 3F  		.byte 038h, 0D7h, 08Fh, 060h, 03Fh, 0D0h, 088h, 067h
               D0 88 67 
 2564  0984   36 D9 81 6E 31  		.byte 036h, 0D9h, 081h, 06Eh, 031h, 0DEh, 086h, 069h
               DE 86 69 
 2565  098C   24 CB 93 7C 23  		.byte 024h, 0CBh, 093h, 07Ch, 023h, 0CCh, 094h, 07Bh
               CC 94 7B 
 2566  0994   2A C5 9D 72 2D  		.byte 02Ah, 0C5h, 09Dh, 072h, 02Dh, 0C2h, 09Ah, 075h
               C2 9A 75 
 2567  099C   70 9F C7 28 77  		.byte 070h, 09Fh, 0C7h, 028h, 077h, 098h, 0C0h, 02Fh
               98 C0 2F 
 2568  09A4   7E 91 C9 26 79  		.byte 07Eh, 091h, 0C9h, 026h, 079h, 096h, 0CEh, 021h
               96 CE 21 
 2569  09AC   6C 83 DB 34 6B  		.byte 06Ch, 083h, 0DBh, 034h, 06Bh, 084h, 0DCh, 033h
               84 DC 33 
 2570  09B4   62 8D D5 3A 65  		.byte 062h, 08Dh, 0D5h, 03Ah, 065h, 08Ah, 0D2h, 03Dh
               8A D2 3D 
 2571  09BC   48 A7 FF 10 4F  		.byte 048h, 0A7h, 0FFh, 010h, 04Fh, 0A0h, 0F8h, 017h
               A0 F8 17 
 2572  09C4   46 A9 F1 1E 41  		.byte 046h, 0A9h, 0F1h, 01Eh, 041h, 0AEh, 0F6h, 019h
               AE F6 19 
 2573  09CC   54 BB E3 0C 53  		.byte 054h, 0BBh, 0E3h, 00Ch, 053h, 0BCh, 0E4h, 00Bh
               BC E4 0B 
 2574  09D4   5A B5 ED 02 5D  		.byte 05Ah, 0B5h, 0EDh, 002h, 05Dh, 0B2h, 0EAh, 005h
               B2 EA 05 
 2575  09DC   E0 0F 57 B8 E7  		.byte 0E0h, 00Fh, 057h, 0B8h, 0E7h, 008h, 050h, 0BFh
               08 50 BF 
 2576  09E4   EE 01 59 B6 E9  		.byte 0EEh, 001h, 059h, 0B6h, 0E9h, 006h, 05Eh, 0B1h
               06 5E B1 
 2577  09EC   FC 13 4B A4 FB  		.byte 0FCh, 013h, 04Bh, 0A4h, 0FBh, 014h, 04Ch, 0A3h
               14 4C A3 
 2578  09F4   F2 1D 45 AA F5  		.byte 0F2h, 01Dh, 045h, 0AAh, 0F5h, 01Ah, 042h, 0ADh
               1A 42 AD 
 2579  09FC   D8 37 6F 80 DF  		.byte 0D8h, 037h, 06Fh, 080h, 0DFh, 030h, 068h, 087h
               30 68 87 
 2580  0A04   D6 39 61 8E D1  		.byte 0D6h, 039h, 061h, 08Eh, 0D1h, 03Eh, 066h, 089h
               3E 66 89 
 2581  0A0C   C4 2B 73 9C C3  		.byte 0C4h, 02Bh, 073h, 09Ch, 0C3h, 02Ch, 074h, 09Bh
               2C 74 9B 
 2582  0A14   CA 25 7D 92 CD  		.byte 0CAh, 025h, 07Dh, 092h, 0CDh, 022h, 07Ah, 095h
  Tue Jun 16 20:06:03 1998                                                                                               Page   49

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

               22 7A 95 
 2583  0A1C   90 7F 27 C8 97  		.byte 090h, 07Fh, 027h, 0C8h, 097h, 078h, 020h, 0CFh
               78 20 CF 
 2584  0A24   9E 71 29 C6 99  		.byte 09Eh, 071h, 029h, 0C6h, 099h, 076h, 02Eh, 0C1h
               76 2E C1 
 2585  0A2C   8C 63 3B D4 8B  		.byte 08Ch, 063h, 03Bh, 0D4h, 08Bh, 064h, 03Ch, 0D3h
               64 3C D3 
 2586  0A34   82 6D 35 DA 85  		.byte 082h, 06Dh, 035h, 0DAh, 085h, 06Ah, 032h, 0DDh
               6A 32 DD 
 2587  0A3C   A8 47 1F F0 AF  		.byte 0A8h, 047h, 01Fh, 0F0h, 0AFh, 040h, 018h, 0F7h
               40 18 F7 
 2588  0A44   A6 49 11 FE A1  		.byte 0A6h, 049h, 011h, 0FEh, 0A1h, 04Eh, 016h, 0F9h
               4E 16 F9 
 2589  0A4C   B4 5B 03 EC B3  		.byte 0B4h, 05Bh, 003h, 0ECh, 0B3h, 05Ch, 004h, 0EBh
               5C 04 EB 
 2590  0A54   BA 55 0D E2 BD  		.byte 0BAh, 055h, 00Dh, 0E2h, 0BDh, 052h, 00Ah, 0E5h
               52 0A E5 
 2591         [00]            	.endif
 2592                         	
 2593                         		; display sizes (allow for easy grep)
 2594         003C            	RAM_size	.var RAM_size		;_size_
 2595         0011            	Sbox8Size	.var Sbox8Size		;_size_
 2596         0010            	Sbox8CallCnt	.var Sbox8CallCnt	;_size_
 2597         0110            	Sbox8ByteCnt	.var Sbox8ByteCnt	;_size_
 2598         0162            	subkeyByteCnt	.var subkeyByteCnt	;_size_
 2599         0090            	f32Size		.var f32Size		;_size_
 2600         0400            	tableSize	.var $-tableStart	;_size_
 2601         0240            	f32ByteCnt	.var f32ByteCnt		;_size_
 2602         0040            	swap1ByteCnt	.var swap1ByteCnt	;_size_
 2603         014A            	op1ByteCnt	.var op1ByteCnt		;_size_
 2604         002E            	rotByteCnt	.var rotByteCnt		;_size_
 2605         07F8            	_sum_		.var tableSize+f32ByteCnt+swap1ByteCnt+op1ByteCnt+rotByteCnt
 2606         07F8            	sumByteCnt	.var _sum_		;_size_
 2607         0897            	codeSize	.var $-codeSize		;_size_
 2608                         	;
 2609                         	;----------------------------------------------------------------
 2610                         	;
 2611                         	; main entry point for test code
 2612                         	;
 2613                         	;----------------------------------------------------------------
 2614                         	;
 2615  0A5C   3F 8C           	main:	clr	kTabPtr			;point into keyTable
 2616  0A5E                   		
 2617  0A5E   BE 8C           	encLoop:ldx	kTabPtr
 2618  0A60   D6 01 00        		lda	keyTable,x
 2619  0A63   26 03           		bne	doTest			;is this list done?
 2620  0A65   9D              	done:	nop
 2621  0A66   20 F4           		bra	main			;do it over again!
 2622  0A68   5C              	doTest:	inx				;bump past key length
 2623  0A69   BF 8C           		stx	kTabPtr			;copy over the test code
 2624                         		; copy over the next example
 2625  0A6B   3F 8D           		clr	tmpPtr
 2626  0A6D   BE 8C           	copyKey:ldx	kTabPtr			;copy key, split into even/odd
 2627  0A6F   D6 01 00        		lda	keyTable,x
 2628  0A72   5C              		inx
 2629  0A73   BF 8C           		stx	kTabPtr
 2630  0A75   BE 8D           		ldx	tmpPtr
  Tue Jun 16 20:06:03 1998                                                                                               Page   50

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2631  0A77   E7 60           		sta	K32e,x
 2632  0A79   5C              		inx
 2633  0A7A   BF 8D           		stx	tmpPtr
 2634  0A7C   A3 08           		cpx	#KEY_SIZE/2		;time to skip SboxKey?
 2635  0A7E   26 05           		bne	noSkipK
 2636  0A80   9F              		txa
 2637  0A81   AB 04           		add	#KEY_SIZE/4
 2638  0A83   B7 8D           		sta	tmpPtr
 2639                         	
 2640  0A85   A3 14           	noSkipK:cpx	#KEY_SIZE+KEY_SIZE/4
 2641  0A87   26 E4           		bne	copyKey
 2642  0A89   3F 8D           		clr	tmpPtr
 2643  0A8B   BE 8C           	copyBlk:ldx	kTabPtr
 2644  0A8D   D6 01 00        		lda	keyTable,x
 2645  0A90   5C              		inx
 2646  0A91   BF 8C           		stx	kTabPtr
 2647  0A93   BE 8D           		ldx	tmpPtr
 2648  0A95   E7 50           		sta	Text,x
 2649  0A97   5C              		inx
 2650  0A98   BF 8D           		stx	tmpPtr
 2651  0A9A   A3 10           		cpx	#BLK_SIZE
 2652  0A9C   26 ED           		bne	copyBlk
 2653                         		; compute remainder
 2654  0A9E   AE 60           		ldx	#K32e
 2655  0AA0   CD 06 16        		jsr	RSremainder
 2656  0AA3   AE 6C           		ldx	#K32e+KBUMP
 2657  0AA5   CD 06 16        		jsr	RSremainder
 2658  0AA8                   		swap4	SboxKey,SboxKey+KBUMP
 2659  0AA8                   		swap1	SboxKey  ,SboxKey+KBUMP
 2660         0AA8            	tmpSwap		.var	$
 2661  0AA8   BE 68           		ldx	SboxKey
 2662  0AAA   B6 74           		lda	SboxKey+KBUMP
 2663  0AAC   BF 74           		stx	SboxKey+KBUMP
 2664  0AAE   B7 68           		sta	SboxKey
 2665         0008            	tmpSwap		.var	$-tmpSwap
 2666         0048            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
 2667  0AB0                   		.endm
 2668  0AB0                   		swap1	SboxKey+1,SboxKey+KBUMP+1
 2669         0AB0            	tmpSwap		.var	$
 2670  0AB0   BE 69           		ldx	SboxKey+1
 2671  0AB2   B6 75           		lda	SboxKey+KBUMP+1
 2672  0AB4   BF 75           		stx	SboxKey+KBUMP+1
 2673  0AB6   B7 69           		sta	SboxKey+1
 2674         0008            	tmpSwap		.var	$-tmpSwap
 2675         0050            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
 2676  0AB8                   		.endm
 2677  0AB8                   		swap1	SboxKey+2,SboxKey+KBUMP+2
 2678         0AB8            	tmpSwap		.var	$
 2679  0AB8   BE 6A           		ldx	SboxKey+2
 2680  0ABA   B6 76           		lda	SboxKey+KBUMP+2
 2681  0ABC   BF 76           		stx	SboxKey+KBUMP+2
 2682  0ABE   B7 6A           		sta	SboxKey+2
 2683         0008            	tmpSwap		.var	$-tmpSwap
 2684         0058            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
 2685  0AC0                   		.endm
 2686  0AC0                   		swap1	SboxKey+3,SboxKey+KBUMP+3
 2687         0AC0            	tmpSwap		.var	$
  Tue Jun 16 20:06:03 1998                                                                                               Page   51

        Twofish for 6805
        Author: Doug Whiting, Hi/fn, May 1998

 2688  0AC0   BE 6B           		ldx	SboxKey+3
 2689  0AC2   B6 77           		lda	SboxKey+KBUMP+3
 2690  0AC4   BF 77           		stx	SboxKey+KBUMP+3
 2691  0AC6   B7 6B           		sta	SboxKey+3
 2692         0008            	tmpSwap		.var	$-tmpSwap
 2693         0060            	swap1ByteCnt .var swap1ByteCnt+tmpSwap
 2694  0AC8                   		.endm
 2695  0AC8                   		.endm
 2696                         	
 2697  0AC8   CD 04 EB        	copied:	jsr	encryptBlock
 2698                         		; should compare results here
 2699  0ACB   3F 8D           		clr	tmpPtr
 2700  0ACD   9D              	bp4:	nop
 2701  0ACE   BE 8C           	cmpLp:	ldx	kTabPtr			;compare cipherText
 2702  0AD0   D6 01 00        		lda	keyTable,X
 2703  0AD3   5C              		inx	
 2704  0AD4   BF 8C           		stx	kTabPtr			;store bumped ptr
 2705  0AD6   BE 8D           		ldx	tmpPtr
 2706  0AD8   E1 50           		cmp	Text,X
 2707  0ADA   26 35           		bne	badEnc
 2708  0ADC   5C              		inx	
 2709  0ADD   BF 8D           		stx	tmpPtr
 2710  0ADF   A3 10           		cpx	#BLK_SIZE
 2711  0AE1   26 EB           		bne	cmpLp
 2712  0AE3   9D              	bp1:	nop				;compare ok!
 2713  0AE4   CD 05 B3        		jsr	decryptBlock	
 2714                         	
 2715  0AE7   B6 8C           		lda	kTabPtr
 2716  0AE9   A0 20           		sub	#BLK_SIZE*2
 2717  0AEB   B7 8C           		sta	kTabPtr			;back up
 2718  0AED   3F 8D           		clr	tmpPtr
 2719  0AEF   BE 8C           	cmpLp2:	ldx	kTabPtr			;compare cipherText
 2720  0AF1   D6 01 00        		lda	keyTable,X
 2721  0AF4   5C              		inx	
 2722  0AF5   BF 8C           		stx	kTabPtr			;store bumped ptr
 2723  0AF7   BE 8D           		ldx	tmpPtr
 2724  0AF9   E1 50           		cmp	Text,X
 2725  0AFB   26 12           		bne	badDec
 2726  0AFD   5C              		inx	
 2727  0AFE   BF 8D           		stx	tmpPtr
 2728  0B00   A3 10           		cpx	#BLK_SIZE
 2729  0B02   26 EB           		bne	cmpLp2
 2730  0B04   9D              	bp3:	nop
 2731  0B05   B6 8C           		lda	kTabPtr
 2732  0B07   AB 10           		add	#BLK_SIZE
 2733  0B09   B7 8C           		sta	kTabPtr
 2734  0B0B   CC 0A 5E        		jmp	encLoop
 2735  0B0E   9D              	bp2:	nop
 2736                         	
 2737  0B0F   20 FE           	badDec:	bra	$
 2738  0B11   20 FE           	badEnc:	bra	$
 2739  0B13                   		
 2740                         		.end	main


             Lines Assembled : 2740                  Errors : 0


